<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard de Retenção</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
      background-color: #0f172a;
      background-image: radial-gradient(circle at 1px 1px, #1e293b 1px, transparent 0);
      background-size: 2rem 2rem;
    }
    .card {
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(51, 65, 85, 0.6);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
    .pill {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(71, 85, 105, 0.6);
      transition: all 0.2s ease-in-out;
    }
    .pill:hover {
      background: rgba(51, 65, 85, 0.8);
      border-color: rgba(100, 116, 139, 0.7);
    }
    tbody tr:hover {
      background-color: rgba(30, 41, 59, 0.45);
    }
    #toast-container {
      position: fixed;
      top: 1.25rem;
      right: 1.25rem;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .toast {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 0.75rem;
      color: #e2e8f0;
      min-width: 280px;
      max-width: 380px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.35), 0 4px 6px -4px rgba(0,0,0,.25);
      animation: toast-in 0.4s ease-out both;
    }
    .toast-success { background-color: #0f766e; border: 1px solid #0d9488; }
    .toast-error { background-color: #be123c; border: 1px solid #9f1239; }
    .toast-info { background-color: #0369a1; border: 1px solid #0ea5e9; }
    .toast.hide { animation: toast-out 0.4s ease-in forwards; }
    @keyframes toast-in { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toast-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(40px); } }
    .sort-button {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: inherit;
      width: 100%;
    }
    .sort-button .sort-indicator {
      font-size: 0.65rem;
      opacity: 0.7;
    }
    .metric-group {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-top: 1px solid rgba(148, 163, 184, 0.18);
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
    }
    .metric-group-sessions { background: rgba(56, 189, 248, 0.18); color: #e0f2fe; }
    .metric-group-revenue { background: rgba(16, 185, 129, 0.18); color: #dcfce7; }
    .metric-group-rps { background: rgba(249, 115, 22, 0.18); color: #ffedd5; }
    .metric-sub {
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.45);
    }
    .metric-sub-sessions { background: rgba(56, 189, 248, 0.12); }
    .metric-sub-revenue { background: rgba(16, 185, 129, 0.12); }
    .metric-sub-rps { background: rgba(249, 115, 22, 0.12); }
    .metric-cell-sessions { background: rgba(56, 189, 248, 0.06); }
    .metric-cell-revenue { background: rgba(16, 185, 129, 0.06); }
    .metric-cell-rps { background: rgba(249, 115, 22, 0.06); }
    .metric-divider { border-left: 1px solid rgba(148, 163, 184, 0.22); }
    .metric-total { background: rgba(15, 23, 42, 0.55); font-weight: 600; }
    .site-header {
      background: rgba(15, 23, 42, 0.55);
      border-right: 1px solid rgba(148, 163, 184, 0.22);
    }
    .site-cell {
      background: rgba(15, 23, 42, 0.35);
      border-right: 1px solid rgba(148, 163, 184, 0.22);
    }
    .scroll-list-10 {
      max-height: 24rem;
      overflow-y: auto;
      overflow-x: auto;
      overscroll-behavior: contain;
    }
    .scroll-list-15 {
      max-height: 32rem;
      overflow-y: auto;
      overflow-x: auto;
      overscroll-behavior: contain;
    }
    .table-head-sticky {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(15, 23, 42, 0.92);
      backdrop-filter: blur(8px);
    }
    .table-head-sticky th {
      background: inherit;
    }
    .searchable-select-wrapper {
      position: relative;
      z-index: 1;
    }
    .searchable-select-wrapper.searchable-open,
    .searchable-select-wrapper:focus-within {
      z-index: 200;
    }
    .searchable-select-icon {
      position: absolute;
      inset: 0.65rem auto auto 0.85rem;
      display: inline-flex;
      align-items: center;
      pointer-events: none;
      color: rgba(148, 163, 184, 0.65);
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .searchable-select {
      width: 100%;
      border-radius: 0.75rem;
      padding: 0.7rem 0.95rem 0.7rem 2.6rem;
      border: 1px solid rgba(71, 85, 105, 0.4);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.78), rgba(15, 23, 42, 0.58));
      color: #e2e8f0;
      font-size: 0.875rem;
      box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.06);
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .searchable-select::placeholder {
      color: rgba(148, 163, 184, 0.55);
    }
    .searchable-select:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.65);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.18);
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.7));
    }
    .searchable-select:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      border-color: rgba(71, 85, 105, 0.2);
      background: rgba(15, 23, 42, 0.35);
    }
    .searchable-select-wrapper:focus-within .searchable-select-icon {
      color: rgba(56, 189, 248, 0.8);
      transform: translateY(-1px);
    }
    .searchable-dropdown {
      position: absolute;
      top: calc(100% + 0.4rem);
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(71, 85, 105, 0.65);
      border-radius: 0.75rem;
      box-shadow: 0 18px 45px -20px rgba(15, 23, 42, 0.9), 0 12px 20px -8px rgba(8, 47, 73, 0.65);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 0.35rem 0;
      max-height: 16rem;
      overflow-y: auto;
      overscroll-behavior: contain;
      z-index: 300;
      display: none;
    }
    .searchable-dropdown.show {
      display: block;
    }
    .searchable-option {
      width: 100%;
      text-align: left;
      padding: 0.55rem 0.95rem;
      font-size: 0.875rem;
      color: #e2e8f0;
      background: transparent;
      border: none;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .searchable-option:hover,
    .searchable-option.active {
      background: rgba(56, 189, 248, 0.16);
      color: #f8fafc;
    }
    .searchable-option-label {
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .searchable-empty {
      padding: 0.7rem 1rem;
      font-size: 0.8125rem;
      color: rgba(148, 163, 184, 0.75);
    }
  </style>
</head>
<body class="text-slate-200">
  <div id="toast-container"></div>
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
    <header class="card rounded-2xl p-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="bg-slate-900/70 p-3 rounded-xl border border-slate-700/60">
            <svg class="w-9 h-9 text-sky-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 5.25C3 4.007 4.007 3 5.25 3h13.5C20.493 3 21.5 4.007 21.5 5.25v13.5A2.25 2.25 0 0119.25 21H5.25A2.25 2.25 0 013 18.75V5.25z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 7.5h9M7.5 12h9m-9 4.5h5.25" />
            </svg>
          </div>
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-teal-300">Dashboard de Retenção</h1>
            <p class="text-slate-400 mt-1">Acompanhe a performance por <span class="text-slate-200 font-semibold">Site</span> e <span class="text-slate-200 font-semibold">URL</span>, descartando sempre a última hora de dados.</p>
          </div>
        </div>
        <div class="inline-flex rounded-xl pill p-1">
          <button id="tab-analise" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold flex items-center gap-2">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l2.25 2.25 3.75-4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Análise
          </button>
          <button id="tab-config" class="px-4 py-2 rounded-lg text-slate-300 hover:text-white flex items-center gap-2">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18m9-9H3" /></svg>
            Configuração
          </button>
        </div>
      </div>
    </header>

    <section id="view-analise" class="space-y-8">
      <div class="card rounded-2xl p-6 space-y-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h2 class="text-lg font-semibold text-slate-100 flex items-center gap-2">
            <svg class="w-6 h-6 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 5.25h16.5M4.5 9h15M3.75 12.75h16.5M4.5 16.5h15" /></svg>
            Filtros
          </h2>
          <span id="latest-info" class="text-xs text-slate-400"></span>
        </div>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-6">
          <div class="lg:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">Operação <span class="text-red-400">*</span></label>
            <div class="searchable-select-wrapper">
              <span class="searchable-select-icon">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5l9-4.5 9 4.5M3 7.5L12 12m0 0l9-4.5M12 12V21" />
                </svg>
              </span>
              <input id="filter-operacao" type="search" class="searchable-select" placeholder="Selecione ou busque operação" autocomplete="off" />
              <div class="searchable-dropdown" data-dropdown-for="filter-operacao"></div>
            </div>
          </div>
          <div class="lg:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">Tráfego <span class="text-red-400">*</span></label>
            <div class="searchable-select-wrapper">
              <span class="searchable-select-icon">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6.75h15m-15 5.25h9m-9 5.25h15" />
                </svg>
              </span>
              <input id="filter-trafego" type="search" class="searchable-select" placeholder="Selecione ou busque tráfego" autocomplete="off" />
              <div class="searchable-dropdown" data-dropdown-for="filter-trafego"></div>
            </div>
          </div>
          <div class="lg:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">Rota (slug)</label>
            <div class="searchable-select-wrapper">
              <span class="searchable-select-icon">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364 6.364l-2.121-2.121M8.757 8.757 6.636 6.636m12.728 0-2.121 2.121m-9.193 9.193-2.121 2.121" />
                </svg>
              </span>
              <input id="filter-rota" type="search" class="searchable-select" placeholder="Selecione operação e tráfego" autocomplete="off" disabled />
              <div class="searchable-dropdown" data-dropdown-for="filter-rota"></div>
            </div>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Data inicial</label>
            <input id="filter-inicio" type="date" class="w-full pill rounded-lg px-3 py-2 text-sm bg-slate-900/40 text-slate-100" />
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Data final</label>
            <input id="filter-fim" type="date" class="w-full pill rounded-lg px-3 py-2 text-sm bg-slate-900/40 text-slate-100" />
          </div>
          <div class="lg:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">Janela de RPS por URL</label>
            <select id="filter-janela" class="w-full pill rounded-lg px-3 py-2 text-sm text-slate-100 bg-slate-900/40">
              <option value="day">Dia inteiro (exceto última hora)</option>
              <option value="last6h">Últimas 6 horas</option>
              <option value="last3h">Últimas 3 horas</option>
            </select>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 justify-between">
          <p class="text-xs text-slate-400">Os filtros de operação e tráfego são obrigatórios. Caso o período não seja informado, será utilizado o dia mais recente disponível.</p>
          <button id="btn-aplicar" class="inline-flex items-center gap-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold px-5 py-2.5 rounded-xl shadow-lg shadow-sky-900/40 transition-all">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M4 2a2 2 0 00-2 2v2.5A1.5 1.5 0 003.5 8h13A1.5 1.5 0 0018 6.5V4a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9.5a.5.5 0 00-.5-.5h-15a.5.5 0 00-.5.5v4A2.5 2.5 0 004.5 16h11a2.5 2.5 0 002.5-2.5v-4z" clip-rule="evenodd" /></svg>
            Aplicar filtros
          </button>
        </div>
      </div>

      <div id="analysis-wrapper" class="space-y-8"></div>
    </section>

    <section id="view-config" class="hidden space-y-6">
      <div class="card rounded-2xl p-6 space-y-5">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-semibold text-slate-100">Mapear URLs por Operação</h2>
          <button id="btn-reset-operacao" class="text-xs text-slate-400 hover:text-slate-200">Limpar formulário</button>
        </div>
        <form id="form-operacao" class="grid md:grid-cols-4 gap-4">
          <input type="hidden" id="operacao-id" />
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">Operação</label>
            <input id="operacao-nome" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100" placeholder="Ex: Retenção US" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">URLs (uma por linha)</label>
            <textarea id="operacao-url" rows="4" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100" placeholder="Informe uma URL por linha"></textarea>
          </div>
          <div class="md:col-span-4">
            <label class="block text-sm text-slate-400 mb-1">Observação (opcional)</label>
            <input id="operacao-nota" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100" placeholder="Notas internas" />
          </div>
          <div class="md:col-span-4 flex gap-3">
            <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold px-4 py-2 rounded-xl">Salvar</button>
            <button type="button" id="btn-operacao-cancel" class="pill px-4 py-2 rounded-xl">Cancelar</button>
          </div>
        </form>
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <label for="operacao-busca" class="text-xs uppercase tracking-wide text-slate-400">Filtrar</label>
          <input id="operacao-busca" type="search" class="pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100 w-full md:w-72" placeholder="Buscar por operação, URL ou observação" />
        </div>
        <div class="overflow-auto scroll-list-10">
          <table class="w-full text-sm min-w-full">
            <thead class="text-slate-400 text-left">
              <tr>
                <th class="py-2 px-2 font-semibold">Operação</th>
                <th class="py-2 px-2 font-semibold">URL</th>
                <th class="py-2 px-2 font-semibold">Observação</th>
                <th class="py-2 px-2 font-semibold w-32">Ações</th>
              </tr>
            </thead>
            <tbody id="operacoes-lista" class="divide-y divide-slate-800/60"></tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl p-6 space-y-5">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h2 class="text-lg font-semibold text-slate-100">Integração de Operações com API</h2>
          <div class="flex items-center gap-3">
            <span id="operacao-integracao-prefill-indicator" class="hidden text-xs font-medium text-sky-300 bg-sky-500/10 border border-sky-400/30 px-3 py-1 rounded-lg">Novo registro baseado em configuração existente</span>
            <span id="operacao-integracao-mode-indicator" class="hidden text-xs font-medium text-amber-300 bg-amber-500/10 border border-amber-400/30 px-3 py-1 rounded-lg">Editando configuração existente</span>
            <button id="btn-reset-operacao-integracao" class="text-xs text-slate-400 hover:text-slate-200">Limpar formulário</button>
          </div>
        </div>
        <form id="form-operacao-integracao" class="grid md:grid-cols-5 gap-4">
          <input type="hidden" id="operacao-integracao-id" />
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">Operação</label>
            <select id="operacao-integracao-operacao" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100">
              <option value="">— selecione —</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Empresa ID</label>
            <input id="operacao-integracao-empresa" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100" placeholder="Ex: 123" />
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Domínio ID</label>
            <input id="operacao-integracao-dominio" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100" placeholder="Ex: 456" />
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Tipo de tráfego</label>
            <select id="operacao-integracao-trafego" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100">
              <option value="">— selecione —</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">Slug da rota</label>
            <input id="operacao-integracao-slug" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100" placeholder="Ex: ofertas-retencao" />
          </div>
          <div class="flex items-center gap-2 md:col-span-5">
            <input id="operacao-integracao-ativo" type="checkbox" class="w-4 h-4 rounded border-slate-600 bg-slate-900/60" />
            <label for="operacao-integracao-ativo" class="text-sm text-slate-300">Ativar automação (atualiza porcentagens a cada 1h)</label>
          </div>
          <div class="md:col-span-5 flex gap-3">
            <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold px-4 py-2 rounded-xl">Salvar</button>
            <button type="button" id="btn-operacao-integracao-cancel" class="pill px-4 py-2 rounded-xl">Cancelar</button>
          </div>
        </form>
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <label for="operacao-integracao-busca" class="text-xs uppercase tracking-wide text-slate-400">Filtrar</label>
          <input id="operacao-integracao-busca" type="search" class="pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100 w-full md:w-80" placeholder="Buscar por operação, IDs ou slug" />
        </div>
        <div class="overflow-auto scroll-list-10">
          <table class="w-full text-sm min-w-full">
            <thead class="text-slate-400 text-left">
              <tr>
                <th class="py-2 px-2 font-semibold">Operação</th>
                <th class="py-2 px-2 font-semibold">Tipo de tráfego</th>
                <th class="py-2 px-2 font-semibold">Empresa ID</th>
                <th class="py-2 px-2 font-semibold">Domínio ID</th>
                <th class="py-2 px-2 font-semibold">Slug rota</th>
                <th class="py-2 px-2 font-semibold">Status</th>
                <th class="py-2 px-2 font-semibold w-32">Ações</th>
              </tr>
            </thead>
            <tbody id="operacao-integracao-lista" class="divide-y divide-slate-800/60"></tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl p-6 space-y-5">
        <h2 class="text-lg font-semibold text-slate-100">Configurar Tráfego e utm_source</h2>
        <form id="form-trafego" class="grid md:grid-cols-3 gap-4">
          <input type="hidden" id="trafego-id" />
          <div>
            <label class="block text-sm text-slate-400 mb-1">Tipo de tráfego</label>
            <select id="trafego-tipo" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100"></select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-slate-400 mb-1">utm_source</label>
            <input id="trafego-source" class="w-full pill rounded-lg px-3 py-2 bg-slate-900/40 text-slate-100" placeholder="Ex: push-main" />
          </div>
          <div class="md:col-span-3 flex gap-3">
            <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold px-4 py-2 rounded-xl">Salvar</button>
            <button type="button" id="btn-trafego-cancel" class="pill px-4 py-2 rounded-xl">Cancelar</button>
          </div>
        </form>
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <label for="trafego-busca" class="text-xs uppercase tracking-wide text-slate-400">Filtrar</label>
          <input id="trafego-busca" type="search" class="pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100 w-full md:w-64" placeholder="Buscar por tipo ou utm_source" />
        </div>
        <div class="overflow-auto scroll-list-10">
          <table class="w-full text-sm min-w-full">
            <thead class="text-slate-400 text-left">
              <tr>
                <th class="py-2 px-2 font-semibold">Tipo</th>
                <th class="py-2 px-2 font-semibold">utm_source</th>
                <th class="py-2 px-2 font-semibold w-28">Ações</th>
              </tr>
            </thead>
            <tbody id="trafego-lista" class="divide-y divide-slate-800/60"></tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl p-6 space-y-4">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-semibold text-slate-100">RevShare por Site</h2>
          <span class="text-xs text-slate-400">Valores entre 0% e 100%. Aplicados em todas as métricas de receita.</span>
        </div>
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <label for="revshare-busca" class="text-xs uppercase tracking-wide text-slate-400">Filtrar</label>
          <input id="revshare-busca" type="search" class="pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100 w-full md:w-64" placeholder="Buscar por site" />
        </div>
        <div class="overflow-auto scroll-list-10">
          <table class="w-full text-sm min-w-full">
            <thead class="text-slate-400 text-left">
              <tr>
                <th class="py-2 px-2 font-semibold">Site</th>
                <th class="py-2 px-2 font-semibold">RevShare (%)</th>
                <th class="py-2 px-2 font-semibold w-28">Ações</th>
              </tr>
            </thead>
            <tbody id="revshare-lista" class="divide-y divide-slate-800/60"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div id="loading-overlay" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-3 text-slate-200 text-center">
      <svg class="w-10 h-10 animate-spin text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span id="loading-text" class="text-sm">Carregando...</span>
      <span id="loading-hint" class="hidden text-xs text-amber-300 leading-relaxed max-w-xs">
        Este carregamento está levando mais tempo que o esperado. Isso pode indicar inconsistência na rota ou nas URLs configuradas para a operação selecionada.
      </span>
    </div>
  </div>

  <script>
    (function () {
      var DETAILED_METRICS = [
        { key: 'sessions', label: 'Sessões', type: 'number' },
        { key: 'revenue', label: 'Receita ($)', type: 'currency' },
        { key: 'rps', label: 'RPS ($)', type: 'currency' },
        { key: 'coverage', label: 'Cobertura (%)', type: 'percent' },
        { key: 'ecpm', label: 'eCPM ($)', type: 'currency' },
        { key: 'effectiveEcpm', label: 'eCPM Efetivo ($)', type: 'currency' }
      ];
      var DETAILED_COLORS = ['#38bdf8', '#34d399', '#f97316', '#a855f7', '#f43f5e', '#facc15', '#22d3ee', '#fb7185', '#4ade80', '#60a5fa'];
      if (window.Chart && window.ChartDataLabels) {
        Chart.register(window.ChartDataLabels);
      }
      var state = {
        config: {
          operations: [],
          operationIntegrations: [],
          traffics: [],
          revshare: [],
          trafficTypes: []
        },
        groupedOperations: [],
        operationIntegrationOptions: [],
        operationIntegrationMap: {},
        integrationIndex: {},
        trafficByType: {},
        filters: {
          operation: '',
          traffic: '',
          route: '',
          startDate: '',
          endDate: '',
          window: 'day'
        },
        sort: {
          site: { key: 'totalRevenue', direction: 'desc' },
          url: { key: 'revenue', direction: 'desc' },
          distributionSites: { key: 'suggestedShare', direction: 'desc' },
          distributionUrls: { key: 'suggestedShare', direction: 'desc' }
        },
        search: {
          operations: '',
          operationIntegrations: '',
          traffics: '',
          revshare: '',
          url: ''
        },
        analysisTab: 'overview',
        distribution: {
          params: null,
          selectedSite: '',
          urlSearch: '',
          dirty: false,
          contextKey: '',
          minimums: []
        },
        detailed: {
          mode: 'url',
          selected: [],
          metrics: ['revenue'],
          search: '',
          allowEmpty: false
        },
        detailedChart: null,
        detailedMetricMenuCleanup: null,
        analysis: null,
        syncingLinkRouter: false,
        integrationPrefillNoticeShown: false
      };

      var loadingTimeoutId = null;
      var loadingDelayedHintShown = false;
      var integrationFormEl = null;
      var integrationSubmitButton = null;
      var integrationEditIndicator = null;
      var integrationPrefillIndicator = null;

      function parseRouteKey(value) {
        if (value == null) {
          return { slug: '', domainId: '' };
        }
        var stringValue = String(value);
        var parts = stringValue.split('::');
        if (parts.length <= 1) {
          return { slug: stringValue.trim(), domainId: '' };
        }
        var slug = parts.shift() || '';
        var domainId = parts.join('::');
        return { slug: slug.trim(), domainId: domainId.trim() };
      }

      function makeRouteKey(slug, domainId) {
        var normalizedSlug = String(slug || '').trim();
        var normalizedDomain = String(domainId || '').trim();
        if (!normalizedSlug && !normalizedDomain) {
          return '';
        }
        return normalizedDomain ? normalizedSlug + '::' + normalizedDomain : normalizedSlug;
      }

      function makeRouteKeyFromItem(item) {
        if (!item) {
          return '';
        }
        return makeRouteKey(item.routeSlug, item.domainId);
      }

      function normalizeRouteKey(value) {
        var parts = parseRouteKey(value);
        return makeRouteKey(parts.slug, parts.domainId).toLowerCase();
      }

      function getRouteSlugFromKey(value) {
        return parseRouteKey(value).slug || '';
      }

      function getRouteDomainIdFromKey(value) {
        return parseRouteKey(value).domainId || '';
      }

      function makeDistributionContextKey(operation, traffic, routeKey) {
        var op = String(operation || '').trim().toLowerCase();
        var tr = String(traffic || '').trim().toLowerCase();
        var parsedRoute = parseRouteKey(routeKey);
        var slug = String(parsedRoute.slug || '').trim().toLowerCase();
        var domain = String(parsedRoute.domainId || '').trim().toLowerCase();
        return [op, tr, slug, domain].join('||');
      }

      var searchableControls = {};

      function ensureSearchableDropdown(input) {
        if (!input) return null;
        var wrapper = input.closest('.searchable-select-wrapper');
        if (!wrapper) return null;
        var dropdown = wrapper.querySelector('.searchable-dropdown');
        if (!dropdown) {
          dropdown = document.createElement('div');
          dropdown.className = 'searchable-dropdown';
          wrapper.appendChild(dropdown);
        }
        return dropdown;
      }

      function initSearchableControl(inputId, onChange) {
        var input = document.getElementById(inputId);
        if (!input) return;
        var control = searchableControls[inputId];
        if (!control) {
          control = searchableControls[inputId] = {
            options: [],
            filteredOptions: [],
            lastValue: '',
            initialized: false,
            onChange: onChange,
            highlightIndex: -1,
            isOpen: false
          };
        } else {
          control.onChange = onChange;
        }
        if (control.initialized) return;

        input.setAttribute('autocomplete', 'off');
        input.removeAttribute('list');

        var wrapper = input.closest('.searchable-select-wrapper');
        var dropdown = ensureSearchableDropdown(input);
        control.dropdown = dropdown;

        var updateHighlightDisplay = function (scrollIntoView) {
          if (!dropdown) return;
          var buttons = dropdown.querySelectorAll('.searchable-option');
          buttons.forEach(function (btn, idx) {
            if (idx === control.highlightIndex) {
              btn.classList.add('active');
              if (scrollIntoView) {
                btn.scrollIntoView({ block: 'nearest' });
              }
            } else {
              btn.classList.remove('active');
            }
          });
        };

        var setHighlight = function (index, scrollIntoView) {
          var count = control.filteredOptions ? control.filteredOptions.length : 0;
          if (!count) {
            control.highlightIndex = -1;
            updateHighlightDisplay(false);
            return;
          }
          if (index < 0) {
            index = count - 1;
          } else if (index >= count) {
            index = 0;
          }
          control.highlightIndex = index;
          updateHighlightDisplay(scrollIntoView);
        };

        var closeDropdown = function () {
          if (!dropdown) return;
          dropdown.classList.remove('show');
          control.isOpen = false;
          control.highlightIndex = -1;
          if (wrapper) {
            wrapper.classList.remove('searchable-open');
          }
        };

        var renderOptions = function (filterValue, keepHighlight) {
          if (!dropdown) return;
          var query = String(filterValue || '').trim().toLowerCase();
          control.filteredOptions = control.options.filter(function (opt) {
            if (!query) return true;
            return opt.searchLabel.indexOf(query) !== -1;
          });
          dropdown.innerHTML = '';

          var shouldOpen = document.activeElement === input || control.isOpen;

          if (!control.filteredOptions.length) {
            control.highlightIndex = -1;
            if (shouldOpen) {
              var empty = document.createElement('div');
              empty.className = 'searchable-empty';
              empty.textContent = 'Nenhum resultado';
              dropdown.appendChild(empty);
              dropdown.classList.add('show');
              control.isOpen = true;
              if (wrapper) {
                wrapper.classList.add('searchable-open');
              }
            } else {
              dropdown.classList.remove('show');
              control.isOpen = false;
              if (wrapper) {
                wrapper.classList.remove('searchable-open');
              }
            }
            return;
          }

          if (!shouldOpen) {
            dropdown.classList.remove('show');
            control.isOpen = false;
            if (wrapper) {
              wrapper.classList.remove('searchable-open');
            }
            return;
          }

          control.filteredOptions.forEach(function (opt) {
            var optionBtn = document.createElement('button');
            optionBtn.type = 'button';
            optionBtn.className = 'searchable-option';
            var labelSpan = document.createElement('span');
            labelSpan.className = 'searchable-option-label';
            labelSpan.textContent = opt.label;
            optionBtn.appendChild(labelSpan);
            optionBtn.addEventListener('mousedown', function (ev) {
              ev.preventDefault();
              commit(opt.value);
            });
            dropdown.appendChild(optionBtn);
          });

          dropdown.classList.add('show');
          control.isOpen = true;
          if (wrapper) {
            wrapper.classList.add('searchable-open');
          }
          if (!keepHighlight || control.highlightIndex < 0 || control.highlightIndex >= control.filteredOptions.length) {
            control.highlightIndex = 0;
          }
          updateHighlightDisplay(false);
        };

        control.render = renderOptions;
        control.close = closeDropdown;

        var commit = function (rawValue, opts) {
          opts = opts || {};
          var normalized = String(rawValue || '').trim().toLowerCase();
          var match = null;
          if (normalized) {
            match = control.options.find(function (opt) {
              return opt.normalized === normalized;
            });
          }
          var newValue = match ? match.value : '';
          var changed = newValue !== control.lastValue;
          control.lastValue = newValue;
          if (input.value !== newValue) {
            input.value = newValue;
          }
          if (changed && typeof control.onChange === 'function') {
            control.onChange(newValue);
          }
          if (!opts.keepOpen) {
            closeDropdown();
          }
        };

        control.commit = commit;

        input.addEventListener('focus', function () {
          renderOptions(input.value, true);
        });
        input.addEventListener('click', function () {
          renderOptions(input.value, true);
        });
        input.addEventListener('change', function (ev) {
          commit(ev.target.value);
        });
        input.addEventListener('blur', function (ev) {
          commit(ev.target.value);
        });
        input.addEventListener('input', function (ev) {
          var value = ev.target.value || '';
          renderOptions(value, false);
          if (!value) {
            commit('', { keepOpen: true });
          }
        });
        input.addEventListener('keydown', function (ev) {
          if (ev.key === 'Escape') {
            ev.preventDefault();
            ev.stopPropagation();
            input.value = '';
            commit('');
            return;
          }
          if (ev.key === 'ArrowDown') {
            ev.preventDefault();
            if (!control.isOpen) {
              renderOptions(input.value, true);
            }
            setHighlight(control.highlightIndex + 1, true);
          } else if (ev.key === 'ArrowUp') {
            ev.preventDefault();
            if (!control.isOpen) {
              renderOptions(input.value, true);
            }
            if (control.highlightIndex < 0) {
              setHighlight(control.filteredOptions.length - 1, true);
            } else {
              setHighlight(control.highlightIndex - 1, true);
            }
          } else if (ev.key === 'Enter') {
            if (control.isOpen && control.highlightIndex > -1 && control.filteredOptions[control.highlightIndex]) {
              ev.preventDefault();
              commit(control.filteredOptions[control.highlightIndex].value);
            }
          }
        });

        control.initialized = true;
      }

      function updateSearchableOptions(inputId, options) {
        var input = document.getElementById(inputId);
        var control = searchableControls[inputId];
        if (!control) {
          control = searchableControls[inputId] = {
            options: [],
            filteredOptions: [],
            lastValue: '',
            initialized: false,
            highlightIndex: -1,
            isOpen: false
          };
        }

        control.options = (options || []).map(function (item) {
          var value = String((item && item.value) || '').trim();
          var label = item && item.label ? String(item.label) : value;
          return {
            value: value,
            label: label,
            normalized: value.toLowerCase(),
            searchLabel: (label + ' ' + value).toLowerCase()
          };
        });

        if (input && !control.options.length) {
          input.value = '';
          control.lastValue = '';
          if (control.close) {
            control.close();
          }
        } else if (control.lastValue) {
          var exists = control.options.some(function (opt) {
            return opt.value === control.lastValue;
          });
          if (!exists) {
            control.lastValue = '';
            if (input) input.value = '';
          }
        }

        if (control.render && input) {
          control.render(input.value, true);
        }
      }

      function setSearchableValue(inputId, value, silent) {
        var input = document.getElementById(inputId);
        var control = searchableControls[inputId];
        var normalized = String(value || '').trim().toLowerCase();
        var match = control && control.options.find(function (opt) {
          return opt.normalized === normalized;
        });
        var finalValue = match ? match.value : '';
        if (input) {
          input.value = finalValue;
        }
        if (control) {
          var changed = control.lastValue !== finalValue;
          control.lastValue = finalValue;
          if (!silent && changed && typeof control.onChange === 'function') {
            control.onChange(finalValue);
          }
          if (control.render) {
            control.render(finalValue, true);
          }
          if (control.close) {
            control.close();
          }
        }
      }

      document.addEventListener('click', function (ev) {
        var target = ev.target;
        Object.keys(searchableControls).forEach(function (inputId) {
          var control = searchableControls[inputId];
          if (!control || !control.dropdown || !control.dropdown.classList.contains('show')) return;
          var input = document.getElementById(inputId);
          if (!input) return;
          var wrapper = input.closest('.searchable-select-wrapper');
          if (wrapper && wrapper.contains(target)) return;
          if (control.close) {
            control.close();
          }
        });
      });

      function setSearchableDisabled(inputId, disabled, placeholder) {
        var input = document.getElementById(inputId);
        if (!input) return;
        input.disabled = !!disabled;
        if (typeof placeholder === 'string') {
          input.placeholder = placeholder;
        }
        if (disabled) {
          input.value = '';
          var control = searchableControls[inputId];
          if (control) {
            control.lastValue = '';
            if (control.close) {
              control.close();
            }
            if (typeof control.onChange === 'function') {
              control.onChange('');
            }
          }
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        bindTabs();
        bindFilters();
        bindForms();
        bindSearchInputs();
        initSearchableControl('filter-operacao', function (value) {
          if (state.filters.operation !== value) {
            state.filters.operation = value;
            state.filters.route = '';
            updateRouteFilter();
          }
        });
        initSearchableControl('filter-trafego', function (value) {
          if (state.filters.traffic !== value) {
            state.filters.traffic = value;
            state.filters.route = '';
            updateRouteFilter();
          }
        });
        initSearchableControl('filter-rota', function (value) {
          state.filters.route = value;
        });
        loadConfig();
      });

      function bindTabs() {
        var tabAnalise = document.getElementById('tab-analise');
        var tabConfig = document.getElementById('tab-config');
        var viewAnalise = document.getElementById('view-analise');
        var viewConfig = document.getElementById('view-config');
        tabAnalise.addEventListener('click', function () {
          tabAnalise.classList.add('bg-blue-600', 'text-white');
          tabConfig.classList.remove('bg-blue-600', 'text-white');
          tabConfig.classList.add('text-slate-300');
          viewAnalise.classList.remove('hidden');
          viewConfig.classList.add('hidden');
        });
        tabConfig.addEventListener('click', function () {
          tabConfig.classList.add('bg-blue-600', 'text-white');
          tabAnalise.classList.remove('bg-blue-600', 'text-white');
          tabAnalise.classList.add('text-slate-300');
          viewConfig.classList.remove('hidden');
          viewAnalise.classList.add('hidden');
        });
      }

      function bindFilters() {
        document.getElementById('filter-janela').addEventListener('change', function (ev) {
          state.filters.window = ev.target.value;
        });
        document.getElementById('btn-aplicar').addEventListener('click', aplicarFiltros);
      }

      function bindForms() {
        document.getElementById('btn-reset-operacao').addEventListener('click', resetOperacaoForm);
        document.getElementById('btn-operacao-cancel').addEventListener('click', resetOperacaoForm);
        document.getElementById('form-operacao').addEventListener('submit', function (ev) {
          ev.preventDefault();
          salvarOperacao();
        });
        var integrationReset = document.getElementById('btn-reset-operacao-integracao');
        if (integrationReset) {
          integrationReset.addEventListener('click', resetOperacaoIntegracaoForm);
        }
        var integrationCancel = document.getElementById('btn-operacao-integracao-cancel');
        if (integrationCancel) {
          integrationCancel.addEventListener('click', resetOperacaoIntegracaoForm);
        }
        var integrationForm = document.getElementById('form-operacao-integracao');
        if (integrationForm) {
          integrationFormEl = integrationForm;
          integrationSubmitButton = integrationForm.querySelector('button[type="submit"]');
          integrationForm.addEventListener('submit', function (ev) {
            ev.preventDefault();
            salvarOperacaoIntegracao();
          });
        }
        document.getElementById('form-trafego').addEventListener('submit', function (ev) {
          ev.preventDefault();
          salvarTrafego();
        });
        document.getElementById('btn-trafego-cancel').addEventListener('click', resetTrafegoForm);
        setIntegrationFormCreateMode();
      }

      function getIntegrationFormElement() {
        if (!integrationFormEl || !document.body.contains(integrationFormEl)) {
          integrationFormEl = document.getElementById('form-operacao-integracao');
        }
        return integrationFormEl;
      }

      function getIntegrationSubmitButton() {
        if (!integrationSubmitButton || !document.body.contains(integrationSubmitButton)) {
          var form = getIntegrationFormElement();
          integrationSubmitButton = form ? form.querySelector('button[type="submit"]') : null;
        }
        return integrationSubmitButton;
      }

      function getIntegrationEditIndicator() {
        if (!integrationEditIndicator || !document.body.contains(integrationEditIndicator)) {
          integrationEditIndicator = document.getElementById('operacao-integracao-mode-indicator');
        }
        return integrationEditIndicator;
      }

      function getIntegrationPrefillIndicator() {
        if (!integrationPrefillIndicator || !document.body.contains(integrationPrefillIndicator)) {
          integrationPrefillIndicator = document.getElementById('operacao-integracao-prefill-indicator');
        }
        return integrationPrefillIndicator;
      }

      function setIntegrationFormCreateMode(options) {
        var form = getIntegrationFormElement();
        if (form) {
          form.dataset.mode = 'create';
          delete form.dataset.editingId;
        }
        var submit = getIntegrationSubmitButton();
        if (submit) {
          submit.textContent = 'Salvar';
        }
        var idInput = document.getElementById('operacao-integracao-id');
        if (idInput) {
          idInput.value = '';
        }
        var editIndicator = getIntegrationEditIndicator();
        if (editIndicator) {
          editIndicator.classList.add('hidden');
        }
        var prefillIndicator = getIntegrationPrefillIndicator();
        if (prefillIndicator) {
          if (options && options.showPrefill) {
            prefillIndicator.classList.remove('hidden');
          } else {
            prefillIndicator.classList.add('hidden');
          }
        }
      }

      function setIntegrationFormEditMode(id) {
        var form = getIntegrationFormElement();
        if (form) {
          form.dataset.mode = 'editing';
          form.dataset.editingId = id || '';
        }
        var submit = getIntegrationSubmitButton();
        if (submit) {
          submit.textContent = 'Atualizar';
        }
        var idInput = document.getElementById('operacao-integracao-id');
        if (idInput) {
          idInput.value = id || '';
        }
        var editIndicator = getIntegrationEditIndicator();
        if (editIndicator) {
          editIndicator.classList.remove('hidden');
        }
        var prefillIndicator = getIntegrationPrefillIndicator();
        if (prefillIndicator) {
          prefillIndicator.classList.add('hidden');
        }
      }

      function isIntegrationFormEditing() {
        var form = getIntegrationFormElement();
        return !!(form && form.dataset.mode === 'editing');
      }

      function bindSearchInputs() {
        var opSearch = document.getElementById('operacao-busca');
        if (opSearch) {
          opSearch.value = state.search.operations || '';
          opSearch.addEventListener('input', function (ev) {
            state.search.operations = ev.target.value;
            renderOperacoesTabela();
          });
        }
        var opIntegrationSearch = document.getElementById('operacao-integracao-busca');
        if (opIntegrationSearch) {
          opIntegrationSearch.value = state.search.operationIntegrations || '';
          opIntegrationSearch.addEventListener('input', function (ev) {
            state.search.operationIntegrations = ev.target.value;
            renderOperacaoIntegracaoTabela();
          });
        }
        var trafegoSearch = document.getElementById('trafego-busca');
        if (trafegoSearch) {
          trafegoSearch.value = state.search.traffics || '';
          trafegoSearch.addEventListener('input', function (ev) {
            state.search.traffics = ev.target.value;
            renderTrafegoTabela();
          });
        }
        var revshareSearch = document.getElementById('revshare-busca');
        if (revshareSearch) {
          revshareSearch.value = state.search.revshare || '';
          revshareSearch.addEventListener('input', function (ev) {
            state.search.revshare = ev.target.value;
            renderRevshareTabela();
          });
        }
      }

      function loadConfig() {
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (data) {
            showLoading(false);
            state.config = data || state.config;
            prepareConfig();
            renderConfig();
            renderFilters();
          })
          .withFailureHandler(handleError)
          .getConfigData();
      }

      function prepareConfig() {
        var grouped = {};
        (state.config.operations || []).forEach(function (item) {
          if (!item || !item.operation) return;
          var key = item.operation;
          if (!grouped[key]) {
            grouped[key] = { name: key, urls: [], items: [] };
          }
          grouped[key].items.push(item);
          if (item.url) grouped[key].urls.push(item.url);
        });
        state.groupedOperations = Object.keys(grouped).map(function (key) { return grouped[key]; }).sort(function (a, b) {
          return a.name.localeCompare(b.name, 'pt-BR');
        });
        var integrationOptions = {};
        state.groupedOperations.forEach(function (group) {
          integrationOptions[group.name] = true;
        });
        state.operationIntegrationMap = {};
        state.integrationIndex = {};
        (state.config.operationIntegrations || []).forEach(function (item) {
          if (!item || !item.operation) return;
          integrationOptions[item.operation] = true;
          if (!state.operationIntegrationMap[item.operation]) {
            state.operationIntegrationMap[item.operation] = [];
          }
          state.operationIntegrationMap[item.operation].push(item);
          if (!state.integrationIndex[item.operation]) {
            state.integrationIndex[item.operation] = {};
          }
          var trafficKey = item.trafficType || '';
          if (!state.integrationIndex[item.operation][trafficKey]) {
            state.integrationIndex[item.operation][trafficKey] = [];
          }
          state.integrationIndex[item.operation][trafficKey].push(item);
        });
        Object.keys(state.operationIntegrationMap).forEach(function (op) {
          state.operationIntegrationMap[op].sort(function (a, b) {
            var trafficCompare = String(a.trafficType || '').localeCompare(String(b.trafficType || ''), 'pt-BR');
            if (trafficCompare !== 0) {
              return trafficCompare;
            }
            return String(a.routeSlug || '').localeCompare(String(b.routeSlug || ''), 'pt-BR');
          });
        });
        Object.keys(state.integrationIndex).forEach(function (op) {
          var byTraffic = state.integrationIndex[op];
          Object.keys(byTraffic).forEach(function (trafficKey) {
            byTraffic[trafficKey].sort(function (a, b) {
              return String(a.routeSlug || '').localeCompare(String(b.routeSlug || ''), 'pt-BR');
            });
          });
        });
        state.operationIntegrationOptions = Object.keys(integrationOptions).sort(function (a, b) {
          return a.localeCompare(b, 'pt-BR');
        });
        var trafficByType = {};
        (state.config.traffics || []).forEach(function (item) {
          if (!item || !item.type) return;
          if (!trafficByType[item.type]) trafficByType[item.type] = [];
          trafficByType[item.type].push(item.source);
        });
        state.trafficByType = trafficByType;
      }

      function getIntegrationRoutes(operation, traffic) {
        if (!operation || !traffic) {
          return [];
        }
        var index = state.integrationIndex || {};
        var byOperation = index[operation];
        if (!byOperation) {
          return [];
        }
        var routes = byOperation[traffic] || [];
        return routes.slice();
      }

      function updateRouteFilter() {
        var routeInput = document.getElementById('filter-rota');
        if (!routeInput) {
          return;
        }
        var operation = state.filters.operation || '';
        var traffic = state.filters.traffic || '';
        if (!operation || !traffic) {
          updateSearchableOptions('filter-rota', []);
          setSearchableDisabled('filter-rota', true, 'Selecione operação e tráfego');
          if (state.filters.route) {
            state.filters.route = '';
          }
          setSearchableValue('filter-rota', '', true);
          return;
        }
        var routes = getIntegrationRoutes(operation, traffic);
        var normalizedCurrent = normalizeRouteKey(state.filters.route);
        if (!routes.length) {
          updateSearchableOptions('filter-rota', []);
          setSearchableDisabled('filter-rota', true, 'Nenhuma rota configurada');
          state.filters.route = '';
          setSearchableValue('filter-rota', '', true);
          return;
        }
        var options = routes.map(function (item) {
          var slug = item && item.routeSlug ? item.routeSlug : '';
          var key = makeRouteKeyFromItem(item);
          var parts = [];
          parts.push(slug || '—');
          if (item && item.domainId) {
            parts.push('Domínio ' + item.domainId);
          }
          return { value: key, label: parts.join(' · ') };
        });
        setSearchableDisabled('filter-rota', false, 'Selecione ou busque rota');
        updateSearchableOptions('filter-rota', options);
        var selected = '';
        if (normalizedCurrent) {
          var match = routes.find(function (item) {
            return normalizeRouteKey(makeRouteKeyFromItem(item)) === normalizedCurrent;
          });
          if (match) {
            selected = makeRouteKeyFromItem(match);
          }
        }
        if (!selected && routes.length === 1) {
          selected = makeRouteKeyFromItem(routes[0]);
        }
        state.filters.route = selected;
        setSearchableValue('filter-rota', selected, true);
      }

      function renderFilters() {
        var operationOptions = state.groupedOperations.map(function (group) {
          return {
            value: group.name,
            label: group.name + ' (' + group.urls.length + ' URL' + (group.urls.length === 1 ? '' : 's') + ')'
          };
        });
        updateSearchableOptions('filter-operacao', operationOptions);
        if (!operationOptions.length) {
          if (state.filters.operation) {
            state.filters.operation = '';
          }
          setSearchableDisabled('filter-operacao', true, 'Nenhuma operação cadastrada');
        } else {
          var normalizedOp = String(state.filters.operation || '').trim().toLowerCase();
          var opMatch = operationOptions.find(function (item) {
            return String(item.value || '').trim().toLowerCase() === normalizedOp;
          });
          if (!opMatch) {
            state.filters.operation = '';
          }
          setSearchableDisabled('filter-operacao', false, 'Selecione ou busque operação');
        }
        setSearchableValue('filter-operacao', state.filters.operation, true);

        var trafficOptions = (state.config.trafficTypes || []).map(function (type) {
          var count = (state.trafficByType[type] || []).length;
          return {
            value: type,
            label: count ? type + ' · ' + count + ' fonte(s)' : type
          };
        });
        updateSearchableOptions('filter-trafego', trafficOptions);
        if (!trafficOptions.length) {
          if (state.filters.traffic) {
            state.filters.traffic = '';
          }
          setSearchableDisabled('filter-trafego', true, 'Nenhum tráfego cadastrado');
        } else {
          var normalizedTraffic = String(state.filters.traffic || '').trim().toLowerCase();
          var trafficMatch = trafficOptions.find(function (item) {
            return String(item.value || '').trim().toLowerCase() === normalizedTraffic;
          });
          if (!trafficMatch) {
            state.filters.traffic = '';
          }
          setSearchableDisabled('filter-trafego', false, 'Selecione ou busque tráfego');
        }
        setSearchableValue('filter-trafego', state.filters.traffic, true);

        updateRouteFilter();
      }

      function renderConfig() {
        renderOperacoesTabela();
        renderOperacaoIntegracaoTabela();
        renderTrafegoTabela();
        renderRevshareTabela();
        renderTrafegoSelect();
      }

      function renderOperacoesTabela() {
        var tbody = document.getElementById('operacoes-lista');
        if (!tbody) return;
        tbody.innerHTML = '';
        var searchValue = (state.search.operations || '').trim().toLowerCase();
        var input = document.getElementById('operacao-busca');
        if (input && input.value !== state.search.operations) {
          input.value = state.search.operations || '';
        }
        var items = (state.config.operations || []).slice();
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="px-2 py-3 text-center text-slate-400">Nenhuma operação cadastrada.</td></tr>';
          return;
        }
        if (searchValue) {
          items = items.filter(function (item) {
            return ['operation', 'url', 'note'].some(function (key) {
              return String(item[key] || '').toLowerCase().indexOf(searchValue) !== -1;
            });
          });
        }
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="px-2 py-3 text-center text-slate-400">Nenhum resultado para o filtro informado.</td></tr>';
          return;
        }
        items.sort(function (a, b) {
          return a.operation.localeCompare(b.operation, 'pt-BR') || (a.url || '').localeCompare(b.url || '', 'pt-BR');
        }).forEach(function (item) {
          var tr = document.createElement('tr');
          tr.innerHTML = [
            '<td class="px-2 py-2 align-top">' + escapeHtml(item.operation || '') + '</td>',
            '<td class="px-2 py-2 align-top text-sky-300 break-all">' + escapeHtml(item.url || '') + '</td>',
            '<td class="px-2 py-2 align-top text-slate-400">' + escapeHtml(item.note || '') + '</td>',
            '<td class="px-2 py-2 align-top"><div class="flex gap-2">' +
              '<button class="px-2 py-1 pill rounded-lg text-xs" data-action="edit" data-id="' + item.id + '">Editar</button>' +
              '<button class="px-2 py-1 bg-rose-600 hover:bg-rose-500 rounded-lg text-xs text-white" data-action="delete" data-id="' + item.id + '">Remover</button>' +
            '</div></td>'
          ].join('');
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button[data-action="edit"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var id = btn.getAttribute('data-id');
            var found = (state.config.operations || []).find(function (item) { return item.id === id; });
            if (!found) return;
            document.getElementById('operacao-id').value = found.id || '';
            document.getElementById('operacao-nome').value = found.operation || '';
            document.getElementById('operacao-url').value = found.url || '';
            document.getElementById('operacao-nota').value = found.note || '';
          });
        });
        tbody.querySelectorAll('button[data-action="delete"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var id = btn.getAttribute('data-id');
            if (!id) return;
            if (!confirm('Remover este mapeamento?')) return;
            showLoading(true);
            google.script.run
              .withSuccessHandler(function (data) {
                showLoading(false);
                showToast('Mapeamento removido.', 'success');
                state.config = data;
                prepareConfig();
                renderConfig();
                renderFilters();
              })
              .withFailureHandler(handleError)
              .deleteOperationConfig(id);
          });
        });
      }

      function attachOperacaoIntegracaoSelectHandler(select) {
        if (!select) return;
        if (select._integrationChangeHandler) {
          select.removeEventListener('change', select._integrationChangeHandler);
        }
        var handler = function (ev) {
          var operation = ev.target.value;
          var map = state.operationIntegrationMap || {};
          var companyInput = document.getElementById('operacao-integracao-empresa');
          var domainInput = document.getElementById('operacao-integracao-dominio');
          var slugInput = document.getElementById('operacao-integracao-slug');
          var trafficInput = document.getElementById('operacao-integracao-trafego');
          var activeInput = document.getElementById('operacao-integracao-ativo');
          var records = operation ? map[operation] || [] : [];
          var record = records.length === 1 ? records[0] : null;
          var wasEditing = isIntegrationFormEditing();
          setIntegrationFormCreateMode({ showPrefill: !!record });
          if (record) {
            if (companyInput) companyInput.value = record.companyId || '';
            if (domainInput) domainInput.value = record.domainId || '';
            if (slugInput) slugInput.value = record.routeSlug || '';
            if (trafficInput) trafficInput.value = record.trafficType || '';
            if (activeInput) activeInput.checked = !!record.active;
            if (wasEditing) {
              showToast('Os dados da configuração atual foram carregados como referência. Ao salvar, um novo registro será criado.', 'info');
            } else if (!state.integrationPrefillNoticeShown) {
              showToast('Os campos foram preenchidos com a configuração atual. Ao salvar será criada uma nova integração.', 'info');
              state.integrationPrefillNoticeShown = true;
            }
          } else {
            if (companyInput) companyInput.value = '';
            if (domainInput) domainInput.value = '';
            if (slugInput) slugInput.value = '';
            if (trafficInput) trafficInput.value = '';
            if (activeInput) activeInput.checked = false;
            if (wasEditing) {
              showToast('Saímos do modo de edição. Preencha os dados para criar uma nova integração.', 'info');
            }
          }
        };
        select._integrationChangeHandler = handler;
        select.addEventListener('change', handler);
      }

      function renderOperacaoIntegracaoTabela() {
        var tbody = document.getElementById('operacao-integracao-lista');
        if (!tbody) return;
        var select = document.getElementById('operacao-integracao-operacao');
        if (select) {
          var currentValue = select.value;
          select.innerHTML = '';
          var placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = '— selecione —';
          select.appendChild(placeholder);
          state.operationIntegrationOptions.forEach(function (name) {
            var opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });
          if (currentValue && state.operationIntegrationOptions.indexOf(currentValue) !== -1) {
            select.value = currentValue;
          } else {
            select.value = '';
          }
          attachOperacaoIntegracaoSelectHandler(select);
        }
        var trafficSelect = document.getElementById('operacao-integracao-trafego');
        if (trafficSelect) {
          var currentTraffic = trafficSelect.value;
          trafficSelect.innerHTML = '';
          var trafficPlaceholder = document.createElement('option');
          trafficPlaceholder.value = '';
          trafficPlaceholder.textContent = '— selecione —';
          trafficSelect.appendChild(trafficPlaceholder);
          (state.config.trafficTypes || []).forEach(function (type) {
            var opt = document.createElement('option');
            opt.value = type;
            opt.textContent = type;
            trafficSelect.appendChild(opt);
          });
          if (currentTraffic && state.config.trafficTypes && state.config.trafficTypes.indexOf(currentTraffic) !== -1) {
            trafficSelect.value = currentTraffic;
          } else {
            trafficSelect.value = '';
          }
        }
        tbody.innerHTML = '';
        var searchValue = (state.search.operationIntegrations || '').trim().toLowerCase();
        var input = document.getElementById('operacao-integracao-busca');
        if (input && input.value !== state.search.operationIntegrations) {
          input.value = state.search.operationIntegrations || '';
        }
        var items = (state.config.operationIntegrations || []).slice();
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="px-2 py-3 text-center text-slate-400">Nenhuma operação integrada.</td></tr>';
          return;
        }
        if (searchValue) {
          items = items.filter(function (item) {
            return ['operation', 'trafficType', 'companyId', 'domainId', 'routeSlug'].some(function (key) {
              return String(item[key] || '').toLowerCase().indexOf(searchValue) !== -1;
            }) || (item.active ? 'ativo' : 'inativo').indexOf(searchValue) !== -1;
          });
        }
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="px-2 py-3 text-center text-slate-400">Nenhum resultado para o filtro informado.</td></tr>';
          return;
        }
        items.sort(function (a, b) {
          return (a.operation || '').localeCompare(b.operation || '', 'pt-BR');
        }).forEach(function (item) {
          var statusClass = item.active ? 'bg-emerald-500/20 text-emerald-300' : 'bg-slate-700/40 text-slate-300';
          var statusLabel = item.active ? 'Ativo' : 'Inativo';
          var tr = document.createElement('tr');
          tr.innerHTML = [
            '<td class="px-2 py-2 align-top">' + escapeHtml(item.operation || '') + '</td>',
            '<td class="px-2 py-2 align-top text-slate-300">' + escapeHtml(item.trafficType || '—') + '</td>',
            '<td class="px-2 py-2 align-top text-slate-300">' + escapeHtml(item.companyId || '') + '</td>',
            '<td class="px-2 py-2 align-top text-slate-300">' + escapeHtml(item.domainId || '') + '</td>',
            '<td class="px-2 py-2 align-top text-sky-300 break-all">' + escapeHtml(item.routeSlug || '') + '</td>',
            '<td class="px-2 py-2 align-top"><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ' + statusClass + '">' + statusLabel + '</span></td>',
            '<td class="px-2 py-2 align-top"><div class="flex gap-2">' +
              '<button class="px-2 py-1 pill rounded-lg text-xs" data-action="edit" data-id="' + escapeHtml(item.id || '') + '">Editar</button>' +
              '<button class="px-2 py-1 bg-rose-600 hover:bg-rose-500 rounded-lg text-xs text-white" data-action="delete" data-id="' + escapeHtml(item.id || '') + '">Remover</button>' +
            '</div></td>'
          ].join('');
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button[data-action="edit"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var id = btn.getAttribute('data-id');
            var found = (state.config.operationIntegrations || []).find(function (item) { return item.id === id; });
            if (!found) return;
            setIntegrationFormEditMode(found.id || '');
            document.getElementById('operacao-integracao-operacao').value = found.operation || '';
            document.getElementById('operacao-integracao-empresa').value = found.companyId || '';
            document.getElementById('operacao-integracao-dominio').value = found.domainId || '';
            document.getElementById('operacao-integracao-trafego').value = found.trafficType || '';
            document.getElementById('operacao-integracao-slug').value = found.routeSlug || '';
            document.getElementById('operacao-integracao-ativo').checked = !!found.active;
          });
        });
        tbody.querySelectorAll('button[data-action="delete"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var id = btn.getAttribute('data-id');
            if (!id) return;
            if (!confirm('Remover esta integração?')) return;
            showLoading(true);
            google.script.run
              .withSuccessHandler(function (data) {
                showLoading(false);
                showToast('Integração removida.', 'success');
                resetOperacaoIntegracaoForm();
                state.config = data;
                prepareConfig();
                renderConfig();
                renderFilters();
              })
              .withFailureHandler(handleError)
              .deleteOperationIntegrationConfig(id);
          });
        });
      }

      function renderTrafegoSelect() {
        var select = document.getElementById('trafego-tipo');
        var current = select.value;
        select.innerHTML = '';
        (state.config.trafficTypes || []).forEach(function (type) {
          var opt = document.createElement('option');
          opt.value = type;
          opt.textContent = type;
          select.appendChild(opt);
        });
        if (current) select.value = current;
      }

      function renderTrafegoTabela() {
        var tbody = document.getElementById('trafego-lista');
        if (!tbody) return;
        tbody.innerHTML = '';
        var searchValue = (state.search.traffics || '').trim().toLowerCase();
        var input = document.getElementById('trafego-busca');
        if (input && input.value !== state.search.traffics) {
          input.value = state.search.traffics || '';
        }
        var items = (state.config.traffics || []).slice();
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="3" class="px-2 py-3 text-center text-slate-400">Nenhuma fonte cadastrada.</td></tr>';
          return;
        }
        if (searchValue) {
          items = items.filter(function (item) {
            return ['type', 'source'].some(function (key) {
              return String(item[key] || '').toLowerCase().indexOf(searchValue) !== -1;
            });
          });
        }
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="3" class="px-2 py-3 text-center text-slate-400">Nenhum resultado para o filtro informado.</td></tr>';
          return;
        }
        items.sort(function (a, b) {
          return a.type.localeCompare(b.type, 'pt-BR') || (a.source || '').localeCompare(b.source || '', 'pt-BR');
        }).forEach(function (item) {
          var tr = document.createElement('tr');
          tr.innerHTML = [
            '<td class="px-2 py-2">' + escapeHtml(item.type || '') + '</td>',
            '<td class="px-2 py-2 text-sky-300 break-all">' + escapeHtml(item.source || '') + '</td>',
            '<td class="px-2 py-2"><div class="flex gap-2">' +
              '<button class="px-2 py-1 pill rounded-lg text-xs" data-action="edit" data-id="' + item.id + '">Editar</button>' +
              '<button class="px-2 py-1 bg-rose-600 hover:bg-rose-500 rounded-lg text-xs text-white" data-action="delete" data-id="' + item.id + '">Remover</button>' +
            '</div></td>'
          ].join('');
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button[data-action="edit"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var id = btn.getAttribute('data-id');
            var found = (state.config.traffics || []).find(function (item) { return item.id === id; });
            if (!found) return;
            document.getElementById('trafego-id').value = found.id || '';
            document.getElementById('trafego-tipo').value = found.type || '';
            document.getElementById('trafego-source').value = found.source || '';
          });
        });
        tbody.querySelectorAll('button[data-action="delete"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var id = btn.getAttribute('data-id');
            if (!id) return;
            if (!confirm('Remover esta utm_source?')) return;
            showLoading(true);
            google.script.run
              .withSuccessHandler(function (data) {
                showLoading(false);
                showToast('utm_source removida.', 'success');
                state.config = data;
                prepareConfig();
                renderConfig();
                renderFilters();
              })
              .withFailureHandler(handleError)
              .deleteTrafficConfig(id);
          });
        });
      }

      function renderRevshareTabela() {
        var tbody = document.getElementById('revshare-lista');
        if (!tbody) return;
        tbody.innerHTML = '';
        var searchValue = (state.search.revshare || '').trim().toLowerCase();
        var input = document.getElementById('revshare-busca');
        if (input && input.value !== state.search.revshare) {
          input.value = state.search.revshare || '';
        }
        var items = (state.config.revshare || []).slice();
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="3" class="px-2 py-3 text-center text-slate-400">Nenhum site identificado a partir das URLs cadastradas.</td></tr>';
          return;
        }
        if (searchValue) {
          items = items.filter(function (item) {
            return ['site', 'revshare'].some(function (key) {
              return String(item[key] || '').toLowerCase().indexOf(searchValue) !== -1;
            });
          });
        }
        if (!items.length) {
          tbody.innerHTML = '<tr><td colspan="3" class="px-2 py-3 text-center text-slate-400">Nenhum resultado para o filtro informado.</td></tr>';
          return;
        }
        items.sort(function (a, b) {
          return (a.site || '').localeCompare(b.site || '', 'pt-BR');
        }).forEach(function (item) {
          var tr = document.createElement('tr');
          tr.innerHTML = [
            '<td class="px-2 py-2">' + escapeHtml(item.site || '') + '</td>',
            '<td class="px-2 py-2"><input type="number" min="0" max="100" step="0.01" class="w-32 pill rounded-lg px-2 py-1 bg-slate-900/40 text-slate-100" value="' + formatInputNumber(item.revshare) + '" data-site="' + escapeHtml(item.site || '') + '" /></td>',
            '<td class="px-2 py-2"><button class="px-3 py-1 bg-teal-600 hover:bg-teal-500 text-white rounded-lg text-xs" data-site="' + escapeHtml(item.site || '') + '">Salvar</button></td>'
          ].join('');
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var site = btn.getAttribute('data-site');
            var row = btn.closest('tr');
            var input = row ? row.querySelector('input[type="number"]') : null;
            if (!input) return;
            var value = input.value;
            if (value !== '' && (Number(value) < 0 || Number(value) > 100)) {
              showToast('Informe um RevShare entre 0 e 100.', 'error');
              return;
            }
            showLoading(true);
            google.script.run
              .withSuccessHandler(function (data) {
                showLoading(false);
                showToast('RevShare atualizado.', 'success');
                state.config = data;
                prepareConfig();
                renderConfig();
                renderFilters();
              })
              .withFailureHandler(handleError)
              .updateRevShare({ site: site, revshare: value });
          });
        });
      }

      function salvarOperacao() {
        var id = document.getElementById('operacao-id').value;
        var operationValue = document.getElementById('operacao-nome').value || '';
        var noteValue = document.getElementById('operacao-nota').value || '';
        var urlsInput = document.getElementById('operacao-url').value || '';
        var operation = operationValue.trim();
        if (!operation) {
          showToast('Informe o nome da operação.', 'error');
          return;
        }
        var parsedUrls = (urlsInput || '')
          .split(/\n+/)
          .map(function (item) { return item.trim(); })
          .filter(function (item) { return item; });
        if (id) {
          if (!parsedUrls.length) {
            showToast('Informe a URL.', 'error');
            return;
          }
          if (parsedUrls.length > 1) {
            showToast('Para atualizar utilize apenas uma URL por vez.', 'error');
            return;
          }
          showLoading(true);
          google.script.run
            .withSuccessHandler(function (data) {
              showLoading(false);
              showToast('Mapeamento salvo com sucesso.', 'success');
              resetOperacaoForm();
              state.config = data;
              prepareConfig();
              renderConfig();
              renderFilters();
            })
            .withFailureHandler(handleError)
            .saveOperationConfig({
              id: id,
              operation: operation,
              url: parsedUrls[0],
              note: noteValue
            });
          return;
        }
        if (!parsedUrls.length) {
          showToast('Informe ao menos uma URL.', 'error');
          return;
        }
        var uniqueInputs = [];
        var seenInputs = {};
        parsedUrls.forEach(function (url) {
          var normalized = url.toLowerCase();
          if (!seenInputs[normalized]) {
            seenInputs[normalized] = true;
            uniqueInputs.push(url);
          }
        });
        var duplicatesInForm = parsedUrls.length - uniqueInputs.length;
        var existingMap = {};
        (state.config.operations || []).forEach(function (item) {
          if (!item) return;
          var opKey = String(item.operation || '').trim().toLowerCase();
          var urlKey = String(item.url || '').trim().toLowerCase();
          if (!opKey || !urlKey) return;
          existingMap[opKey + '|' + urlKey] = true;
        });
        var operationKey = operation.toLowerCase();
        var urlsToCreate = uniqueInputs.filter(function (url) {
          var key = operationKey + '|' + url.toLowerCase();
          return !existingMap[key];
        });
        var alreadyExisting = uniqueInputs.length - urlsToCreate.length;
        if (!urlsToCreate.length) {
          var infoMessage = 'As URLs informadas já estão cadastradas para esta operação.';
          if (duplicatesInForm > 0) {
            infoMessage += ' ' + duplicatesInForm + ' duplicada(s) no formulário foram desconsideradas.';
          }
          showToast(infoMessage, 'info');
          return;
        }
        showLoading(true);
        var createdCount = 0;
        var queue = urlsToCreate.slice();
        var lastConfig = null;

        function finalizeCreation() {
          if (lastConfig) {
            state.config = lastConfig;
            prepareConfig();
            renderConfig();
            renderFilters();
          }
          showLoading(false);
          var messageParts = [];
          messageParts.push(createdCount + (createdCount === 1 ? ' URL cadastrada com sucesso.' : ' URLs cadastradas com sucesso.'));
          if (alreadyExisting > 0) {
            messageParts.push(alreadyExisting + ' URL(s) já estavam cadastradas e foram ignoradas.');
          }
          if (duplicatesInForm > 0) {
            messageParts.push(duplicatesInForm + ' duplicada(s) no formulário foram desconsideradas.');
          }
          showToast(messageParts.join(' '), 'success');
          resetOperacaoForm();
        }

        function processNext() {
          if (!queue.length) {
            finalizeCreation();
            return;
          }
          var currentUrl = queue.shift();
          google.script.run
            .withSuccessHandler(function (data) {
              createdCount++;
              lastConfig = data;
              processNext();
            })
            .withFailureHandler(function (error) {
              handleError(error);
            })
            .saveOperationConfig({
              id: '',
              operation: operation,
              url: currentUrl,
              note: noteValue
            });
        }
        processNext();
      }

      function salvarOperacaoIntegracao() {
        var form = getIntegrationFormElement();
        var isEditing = form && form.dataset.mode === 'editing';
        var payload = {
          id: document.getElementById('operacao-integracao-id').value,
          operation: document.getElementById('operacao-integracao-operacao').value,
          trafficType: document.getElementById('operacao-integracao-trafego').value,
          companyId: document.getElementById('operacao-integracao-empresa').value,
          domainId: document.getElementById('operacao-integracao-dominio').value,
          routeSlug: document.getElementById('operacao-integracao-slug').value,
          active: document.getElementById('operacao-integracao-ativo').checked
        };
        if (isEditing) {
          if (!payload.id) {
            payload.id = form && form.dataset.editingId ? form.dataset.editingId : '';
          }
          if (!payload.id) {
            showToast('Não foi possível identificar a integração em edição. Clique em "Editar" novamente.', 'error');
            return;
          }
        } else {
          payload.id = '';
        }
        if (!payload.operation) {
          showToast('Selecione a operação.', 'error');
          return;
        }
        if (!payload.trafficType) {
          showToast('Selecione o tipo de tráfego.', 'error');
          return;
        }
        if (payload.active && (!payload.companyId || !payload.domainId || !payload.routeSlug)) {
          showToast('Informe Empresa ID, Domínio ID e Slug da rota para ativar.', 'error');
          return;
        }
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (data) {
            showLoading(false);
            showToast('Integração salva.', 'success');
            resetOperacaoIntegracaoForm();
            state.config = data;
            prepareConfig();
            renderConfig();
            renderFilters();
          })
          .withFailureHandler(handleError)
          .saveOperationIntegrationConfig(payload);
      }

      function salvarTrafego() {
        var payload = {
          id: document.getElementById('trafego-id').value,
          type: document.getElementById('trafego-tipo').value,
          source: document.getElementById('trafego-source').value
        };
        if (!payload.type) {
          showToast('Selecione o tipo de tráfego.', 'error');
          return;
        }
        if (!payload.source) {
          showToast('Informe a utm_source.', 'error');
          return;
        }
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (data) {
            showLoading(false);
            showToast('utm_source salva.', 'success');
            resetTrafegoForm();
            state.config = data;
            prepareConfig();
            renderConfig();
            renderFilters();
          })
          .withFailureHandler(handleError)
          .saveTrafficConfig(payload);
      }

      function resetOperacaoForm() {
        document.getElementById('operacao-id').value = '';
        document.getElementById('operacao-nome').value = '';
        document.getElementById('operacao-url').value = '';
        document.getElementById('operacao-nota').value = '';
      }

      function resetOperacaoIntegracaoForm() {
        setIntegrationFormCreateMode();
        state.integrationPrefillNoticeShown = false;
        var select = document.getElementById('operacao-integracao-operacao');
        if (select) {
          select.value = '';
        }
        document.getElementById('operacao-integracao-empresa').value = '';
        document.getElementById('operacao-integracao-dominio').value = '';
        var trafficSelect = document.getElementById('operacao-integracao-trafego');
        if (trafficSelect) {
          trafficSelect.value = '';
        }
        document.getElementById('operacao-integracao-slug').value = '';
        document.getElementById('operacao-integracao-ativo').checked = false;
      }

      function resetTrafegoForm() {
        document.getElementById('trafego-id').value = '';
        document.getElementById('trafego-source').value = '';
      }

      function aplicarFiltros() {
        var operation = document.getElementById('filter-operacao').value;
        var traffic = document.getElementById('filter-trafego').value;
        var routeSelect = document.getElementById('filter-rota');
        var routeKey = routeSelect ? routeSelect.value : '';
        var startDate = document.getElementById('filter-inicio').value;
        var endDate = document.getElementById('filter-fim').value;
        var window = document.getElementById('filter-janela').value;
        if (!operation) {
          showToast('Selecione uma operação.', 'error');
          return;
        }
        if (!traffic) {
          showToast('Selecione um tipo de tráfego.', 'error');
          return;
        }
        var availableRoutes = getIntegrationRoutes(operation, traffic);
        if (!routeKey && availableRoutes.length === 1) {
          routeKey = makeRouteKeyFromItem(availableRoutes[0]);
        }
        var routeSlug = getRouteSlugFromKey(routeKey);
        var routeDomainId = getRouteDomainIdFromKey(routeKey);
        state.filters.operation = operation;
        state.filters.traffic = traffic;
        state.filters.route = routeKey;
        state.filters.startDate = startDate;
        state.filters.endDate = endDate;
        state.filters.window = window;
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (data) {
            showLoading(false);
            normalizeDistributionEffectiveEcpm(data && data.distribution);
            state.analysis = data;
            var integration = data && data.integration ? data.integration : null;
            var responseFilters = data && data.filters ? data.filters : {};
            var selectedRouteKey = makeRouteKey(responseFilters.route, responseFilters.domainId);
            if (!selectedRouteKey && integration) {
              selectedRouteKey = makeRouteKey(integration.routeSlug, integration.domainId);
            }
            if (!selectedRouteKey) {
              selectedRouteKey = makeRouteKey(routeSlug, routeDomainId);
            }
            state.filters.route = selectedRouteKey;
            updateRouteFilter();
            state.filters.startDate = responseFilters.startDate || '';
            state.filters.endDate = responseFilters.endDate || '';
            var startInput = document.getElementById('filter-inicio');
            if (startInput) {
              startInput.value = responseFilters.startDate || '';
            }
            var endInput = document.getElementById('filter-fim');
            if (endInput) {
              endInput.value = responseFilters.endDate || '';
            }
            var contextKey = makeDistributionContextKey(
              responseFilters.operation || state.filters.operation,
              responseFilters.traffic || state.filters.traffic,
              state.filters.route
            );
            syncDistributionState(data && data.distribution, true, contextKey);
            renderAnalysis();
          })
          .withFailureHandler(handleError)
          .getDashboardData({
            operation: operation,
            traffic: traffic,
            routeSlug: routeSlug,
            domainId: routeDomainId,
            startDate: startDate,
            endDate: endDate,
            urlWindow: window,
            distribution: getDistributionPayload()
          });
      }

      function renderAnalysis() {
        var wrapper = document.getElementById('analysis-wrapper');
        wrapper.innerHTML = '';
        var data = state.analysis;
        var siteRows = data && data.site && data.site.rows ? data.site.rows.length : 0;
        var urlRows = data && data.url && data.url.rows ? data.url.rows.length : 0;
        var distributionRows = data && data.distribution && data.distribution.sites ? data.distribution.sites.length : 0;
        var detailedRows = data && data.detailed && data.detailed.hours && data.detailed.hours.length && ((data.detailed.urls && data.detailed.urls.length) || (data.detailed.sites && data.detailed.sites.length)) ? 1 : 0;
        if (!data || (!siteRows && !urlRows && !distributionRows && !detailedRows)) {
          wrapper.innerHTML = '<div class="card rounded-2xl p-6 text-center text-slate-400">Nenhum dado encontrado para os filtros selecionados.</div>';
          document.getElementById('latest-info').textContent = '';
          return;
        }
        if (data && data.distribution) {
          syncDistributionState(data.distribution);
        }
        ensureActiveAnalysisTab(data);
        if (state.analysisTab !== 'detailed') {
          cleanupDetailedMetricMenu();
        }
        if (state.analysisTab !== 'detailed' && state.detailedChart) {
          state.detailedChart.destroy();
          state.detailedChart = null;
        }
        wrapper.appendChild(renderAnalysisTabs(data));
        if (state.analysisTab === 'distribution') {
          var infoParts = [];
          var distributionInfo = buildDistributionInfo(data && data.distribution);
          if (distributionInfo) infoParts.push(distributionInfo);
          var integrationInfo = buildIntegrationInfo(data && data.integration);
          if (integrationInfo) infoParts.push(integrationInfo);
          document.getElementById('latest-info').textContent = infoParts.join(' • ');
          renderDistributionView(data && data.distribution, wrapper);
          return;
        }
        if (state.analysisTab === 'detailed') {
          document.getElementById('latest-info').textContent = buildDetailedInfo(data && data.detailed, data && data.filters);
          renderDetailedView(data && data.detailed, wrapper);
          return;
        }
        if (siteRows || urlRows) {
          document.getElementById('latest-info').textContent = buildOverviewInfo(data);
        } else {
          document.getElementById('latest-info').textContent = '';
        }
        if (!siteRows && !urlRows) {
          var emptyOverview = document.createElement('div');
          emptyOverview.className = 'card rounded-2xl p-6 text-center text-slate-400';
          emptyOverview.textContent = 'Sem dados de resumo para os filtros selecionados.';
          wrapper.appendChild(emptyOverview);
          return;
        }
        if (siteRows) {
          wrapper.appendChild(renderSiteCard(data.site));
        }
        if (urlRows) {
          wrapper.appendChild(renderUrlCard(data.url, data.filters));
        }
      }

      function ensureActiveAnalysisTab(data) {
        var hasOverview = data && ((data.site && data.site.rows && data.site.rows.length) || (data.url && data.url.rows && data.url.rows.length));
        var hasDetailed = data && data.detailed && data.detailed.hours && data.detailed.hours.length && ((data.detailed.urls && data.detailed.urls.length) || (data.detailed.sites && data.detailed.sites.length));
        var hasDistribution = false;
        if (data && data.distribution) {
          var dist = data.distribution;
          hasDistribution = (dist.sites && dist.sites.length) || dist.requiresRouteSelection;
        }
        var current = state.analysisTab;
        var available = {
          overview: !!hasOverview,
          detailed: !!hasDetailed,
          distribution: !!hasDistribution
        };
        if (!available[current]) {
          if (available.overview) {
            state.analysisTab = 'overview';
          } else if (available.detailed) {
            state.analysisTab = 'detailed';
          } else if (available.distribution) {
            state.analysisTab = 'distribution';
          } else {
            state.analysisTab = 'overview';
          }
        }
      }

      function renderAnalysisTabs(data) {
        var tabsCard = document.createElement('div');
        tabsCard.className = 'card rounded-2xl p-2 flex flex-wrap gap-2';
        var hasOverview = data && data.site && data.site.rows && data.site.rows.length;
        hasOverview = hasOverview || (data && data.url && data.url.rows && data.url.rows.length);
        var hasDistribution = false;
        if (data && data.distribution) {
          var dist = data.distribution;
          hasDistribution = (dist.sites && dist.sites.length) || dist.requiresRouteSelection;
        }
        var hasDetailed = data && data.detailed && data.detailed.hours && data.detailed.hours.length && ((data.detailed.urls && data.detailed.urls.length) || (data.detailed.sites && data.detailed.sites.length));
        var tabs = [
          { id: 'overview', label: 'Resumo de desempenho', available: hasOverview },
          { id: 'detailed', label: 'Análise detalhada', available: hasDetailed },
          { id: 'distribution', label: 'Distribuição inteligente', available: hasDistribution }
        ];
        tabs.forEach(function (tab) {
          var button = document.createElement('button');
          button.type = 'button';
          var isActive = state.analysisTab === tab.id;
          button.className = 'px-4 py-2 rounded-lg font-semibold transition-colors';
          if (isActive) {
            button.classList.add('bg-sky-600', 'text-white');
          } else {
            button.classList.add('text-slate-300', 'hover:text-white');
          }
          button.textContent = tab.label;
          if (!tab.available) {
            button.disabled = true;
            button.classList.add('opacity-60', 'cursor-not-allowed');
          } else {
            button.addEventListener('click', function (ev) {
              ev.preventDefault();
              setAnalysisTab(tab.id);
            });
          }
          tabsCard.appendChild(button);
        });
        return tabsCard;
      }

      function buildOverviewInfo(data) {
        if (!data) return '';
        var infoParts = [];
        if (data.filters && data.filters.latestHour) {
          infoParts.push('Última hora descartada: ' + data.filters.latestHour);
        }
        if (data.site && data.site.hours && data.site.hours.length) {
          var hoursLabels = data.site.hours.map(function (hour) { return hour.label; });
          if (hoursLabels.length) {
            infoParts.push('Horas exibidas: ' + hoursLabels.join(', '));
          }
        }
        return infoParts.join(' • ');
      }

      function buildDetailedInfo(detailed, filters) {
        if (!detailed) return '';
        var infoParts = [];
        if (filters && filters.latestHour) {
          infoParts.push('Última hora descartada: ' + filters.latestHour);
        }
        if (detailed.hours && detailed.hours.length) {
          var labels = detailed.hours.map(function (hour) { return hour.label; });
          if (labels.length) {
            infoParts.push('Horas disponíveis: ' + labels.join(', '));
          }
        }
        return infoParts.join(' • ');
      }

      function buildDistributionInfo(distribution) {
        if (!distribution) return '';
        if (distribution.requiresRouteSelection) {
          return 'Selecione o slug da rota para liberar o plano de distribuição.';
        }
        var infoParts = [];
        if (distribution.latestHour) {
          infoParts.push('Última hora descartada: ' + distribution.latestHour);
        }
        if (distribution.hours && distribution.hours.length) {
          infoParts.push('Horas base: ' + distribution.hours.join(', '));
        }
        if (distribution.missingRouteLinks && distribution.missingRouteLinks.length) {
          infoParts.push('URLs sem dados na rota: ' + distribution.missingRouteLinks.length);
        }
        return infoParts.join(' • ');
      }

      function buildIntegrationInfo(integration) {
        if (!integration) return 'Integração não configurada';
        var infoParts = [];
        infoParts.push(integration.active ? 'Automação ativa' : 'Automação inativa');
        if (integration.trafficType) {
          infoParts.push('Tráfego ' + integration.trafficType);
        }
        if (integration.companyId) {
          infoParts.push('Empresa ' + integration.companyId);
        }
        if (integration.domainId) {
          infoParts.push('Domínio ' + integration.domainId);
        }
        if (integration.routeSlug) {
          infoParts.push('Slug ' + integration.routeSlug);
        }
        return infoParts.join(' • ');
      }

      function renderDetailedView(detailed, wrapper) {
        if (!detailed) {
          var empty = document.createElement('div');
          empty.className = 'card rounded-2xl p-6 text-center text-slate-400';
          empty.textContent = 'Sem dados detalhados disponíveis.';
          wrapper.appendChild(empty);
          return;
        }
        ensureDetailedState(detailed);
        wrapper.appendChild(renderDetailedControlsCard(detailed));
        var selectedItems = getDetailedSelectedItems(detailed);
        wrapper.appendChild(renderDetailedSummaryCard(detailed, selectedItems));
        if (!selectedItems.length) {
          return;
        }
        wrapper.appendChild(renderDetailedChartCard(detailed, selectedItems));
        wrapper.appendChild(renderDetailedTimelineCard(detailed, selectedItems));
      }

      function renderDetailedControlsCard(detailed) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between flex-wrap gap-3';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Controles da análise detalhada';
        header.appendChild(title);
        var count = document.createElement('span');
        count.className = 'text-xs text-slate-400';
        count.textContent = (state.detailed.mode === 'url' ? 'URLs' : 'Sites') + ' selecionados: ' + state.detailed.selected.length;
        header.appendChild(count);
        card.appendChild(header);

        var toggleRow = document.createElement('div');
        toggleRow.className = 'inline-flex rounded-xl pill p-1';
        [
          { key: 'url', label: 'URLs' },
          { key: 'site', label: 'Sites' }
        ].forEach(function (option) {
          var button = document.createElement('button');
          button.type = 'button';
          button.className = 'px-4 py-2 rounded-lg font-semibold transition-colors';
          if (state.detailed.mode === option.key) {
            button.classList.add('bg-sky-600', 'text-white');
          } else {
            button.classList.add('text-slate-300', 'hover:text-white');
          }
          button.textContent = option.label;
          button.addEventListener('click', function (ev) {
            ev.preventDefault();
            setDetailedMode(option.key);
          });
          toggleRow.appendChild(button);
        });
        card.appendChild(toggleRow);

        var searchWrapper = document.createElement('div');
        searchWrapper.className = 'flex flex-col gap-2';
        var searchLabel = document.createElement('label');
        searchLabel.className = 'text-sm text-slate-300';
        searchLabel.textContent = 'Buscar ' + (state.detailed.mode === 'url' ? 'URLs' : 'sites');
        searchWrapper.appendChild(searchLabel);
        var searchInput = document.createElement('input');
        searchInput.type = 'search';
        searchInput.id = 'detailed-search-input';
        searchInput.className = 'pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100';
        searchInput.placeholder = 'Digite para filtrar...';
        searchInput.value = state.detailed.search || '';
        searchInput.addEventListener('input', function (ev) {
          updateDetailedSearch(ev.target.value || '', ev.target);
        });
        searchWrapper.appendChild(searchInput);
        card.appendChild(searchWrapper);

        var bulkActions = document.createElement('div');
        bulkActions.className = 'flex flex-wrap items-center gap-2 text-xs';
        var selectAll = document.createElement('button');
        selectAll.type = 'button';
        selectAll.className = 'px-3 py-1.5 rounded-lg border border-slate-700/60 bg-slate-900/40 font-semibold text-slate-200 hover:border-sky-500/60 hover:text-white transition-colors';
        selectAll.textContent = 'Selecionar todos';
        selectAll.addEventListener('click', function (ev) {
          ev.preventDefault();
          selectAllDetailedItems();
        });
        bulkActions.appendChild(selectAll);
        var clearAll = document.createElement('button');
        clearAll.type = 'button';
        clearAll.className = 'px-3 py-1.5 rounded-lg border border-transparent text-slate-300 hover:text-white hover:border-slate-700/60 transition-colors';
        clearAll.textContent = 'Limpar tudo';
        clearAll.addEventListener('click', function (ev) {
          ev.preventDefault();
          clearDetailedSelection();
        });
        bulkActions.appendChild(clearAll);
        card.appendChild(bulkActions);

        var listContainer = document.createElement('div');
        listContainer.className = 'scroll-list-15 space-y-2 pr-1';
        var items = getDetailedItems(detailed);
        var filtered = items;
        if (state.detailed.search) {
          var searchLower = state.detailed.search.toLowerCase();
          filtered = items.filter(function (item) {
            var primary = (state.detailed.mode === 'url' ? item.url : item.site) || '';
            var secondary = state.detailed.mode === 'url' ? (item.site || '') : '';
            return primary.toLowerCase().indexOf(searchLower) !== -1 || secondary.toLowerCase().indexOf(searchLower) !== -1;
          });
        }
        if (!filtered.length) {
          var empty = document.createElement('div');
          empty.className = 'text-sm text-slate-400';
          empty.textContent = items.length ? 'Nenhum item encontrado com o filtro atual.' : 'Nenhum item disponível para análise.';
          listContainer.appendChild(empty);
        } else {
          filtered.forEach(function (item) {
            var isChecked = state.detailed.selected.indexOf(item.key) !== -1;
            var option = document.createElement('label');
            option.className = 'flex items-center justify-between gap-3 px-3 py-2 rounded-xl border transition-all cursor-pointer';
            option.classList.add('border-slate-700/60', 'bg-slate-900/30');
            if (isChecked) {
              option.classList.add('border-sky-500/60', 'bg-sky-500/10');
            }
            var textWrapper = document.createElement('div');
            textWrapper.className = 'flex flex-col';
            var titleLine = document.createElement('span');
            titleLine.className = 'text-sm font-semibold text-slate-100 break-all';
            titleLine.textContent = state.detailed.mode === 'url' ? item.url : item.site;
            textWrapper.appendChild(titleLine);
            if (state.detailed.mode === 'url') {
              var subtitle = document.createElement('span');
              subtitle.className = 'text-xs text-slate-400';
              subtitle.textContent = item.site || '';
              textWrapper.appendChild(subtitle);
            }
            var metricLine = document.createElement('span');
            metricLine.className = 'text-xs text-slate-400';
            metricLine.textContent = 'Sessões: ' + formatNumber(item.totals.sessions || 0) + ' • eCPM Efetivo: ' + formatCurrency(item.totals.effectiveEcpm || 0);
            textWrapper.appendChild(metricLine);
            option.appendChild(textWrapper);

            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = isChecked;
            checkbox.className = 'h-4 w-4 text-sky-500';
            checkbox.addEventListener('change', function () {
              toggleDetailedSelection(item.key);
            });
            option.appendChild(checkbox);
            option.addEventListener('click', function (ev) {
              if (ev.target !== checkbox) {
                ev.preventDefault();
                checkbox.click();
              }
            });
            listContainer.appendChild(option);
          });
        }
        card.appendChild(listContainer);

        return card;
      }

      function getDetailedItems(detailed) {
        if (!detailed) return [];
        return state.detailed.mode === 'url' ? (detailed.urls || []) : (detailed.sites || []);
      }

      function getDetailedSelectedItems(detailed) {
        var items = getDetailedItems(detailed);
        var selectedSet = {};
        (state.detailed.selected || []).forEach(function (key) { selectedSet[key] = true; });
        return items.filter(function (item) {
          return selectedSet[item.key];
        });
      }

      function ensureDetailedState(detailed) {
        if (!state.detailed) {
          state.detailed = { mode: 'url', selected: [], metrics: ['revenue'], search: '', allowEmpty: false };
        }
        if (typeof state.detailed.allowEmpty === 'undefined') {
          state.detailed.allowEmpty = false;
        }
        var hasUrls = detailed && detailed.urls && detailed.urls.length;
        var hasSites = detailed && detailed.sites && detailed.sites.length;
        if (state.detailed.mode === 'url' && !hasUrls && hasSites) {
          state.detailed.mode = 'site';
        } else if (state.detailed.mode === 'site' && !hasSites && hasUrls) {
          state.detailed.mode = 'url';
        }
        var items = getDetailedItems(detailed);
        var validKeys = {};
        items.forEach(function (item) { validKeys[item.key] = true; });
        state.detailed.selected = (state.detailed.selected || []).filter(function (key) { return validKeys[key]; });
        if (!state.detailed.selected.length && items.length && !state.detailed.allowEmpty) {
          var limit = Math.min(items.length, state.detailed.mode === 'url' ? 5 : 3);
          var defaults = [];
          for (var i = 0; i < limit; i++) {
            defaults.push(items[i].key);
          }
          state.detailed.selected = defaults;
          state.detailed.allowEmpty = false;
        }
        if (!state.detailed.metrics || !state.detailed.metrics.length) {
          state.detailed.metrics = ['revenue'];
        }
      }

      function setDetailedMode(mode) {
        if (state.detailed.mode === mode) return;
        state.detailed.mode = mode;
        state.detailed.allowEmpty = false;
        ensureDetailedState(state.analysis && state.analysis.detailed);
        renderAnalysis();
      }

      function updateDetailedSearch(value, sourceInput) {
        var selectionStart = null;
        var selectionEnd = null;
        if (sourceInput && typeof sourceInput.selectionStart === 'number' && typeof sourceInput.selectionEnd === 'number') {
          selectionStart = sourceInput.selectionStart;
          selectionEnd = sourceInput.selectionEnd;
        } else if (value != null) {
          selectionStart = selectionEnd = String(value).length;
        }
        state.detailed.search = value || '';
        renderAnalysis();
        var schedule = typeof window !== 'undefined' && window.requestAnimationFrame ? window.requestAnimationFrame.bind(window) : function (cb) {
          return setTimeout(cb, 0);
        };
        schedule(function () {
          var input = document.getElementById('detailed-search-input');
          if (!input) return;
          input.focus();
          var start = selectionStart != null ? selectionStart : input.value.length;
          var end = selectionEnd != null ? selectionEnd : start;
          try {
            input.setSelectionRange(start, end);
          } catch (err) {}
        });
      }

      function toggleDetailedSelection(key) {
        var index = state.detailed.selected.indexOf(key);
        if (index === -1) {
          state.detailed.selected.push(key);
        } else {
          state.detailed.selected.splice(index, 1);
        }
        state.detailed.allowEmpty = state.detailed.selected.length === 0;
        renderAnalysis();
      }

      function selectAllDetailedItems() {
        if (!state.analysis || !state.analysis.detailed) return;
        var items = getDetailedItems(state.analysis.detailed);
        state.detailed.selected = items.map(function (item) { return item.key; });
        state.detailed.allowEmpty = false;
        renderAnalysis();
      }

      function clearDetailedSelection() {
        state.detailed.selected = [];
        state.detailed.allowEmpty = true;
        renderAnalysis();
      }

      function toggleDetailedMetric(metricKey, isChecked) {
        var metrics = state.detailed.metrics.slice();
        var index = metrics.indexOf(metricKey);
        if (isChecked && index === -1) {
          metrics.push(metricKey);
        } else if (!isChecked && index !== -1) {
          metrics.splice(index, 1);
        }
        if (!metrics.length) {
          return renderAnalysis();
        }
        state.detailed.metrics = metrics;
        renderAnalysis();
      }

      function cleanupDetailedMetricMenu() {
        if (state.detailedMetricMenuCleanup) {
          state.detailedMetricMenuCleanup();
          state.detailedMetricMenuCleanup = null;
        }
      }

      function buildDetailedMetricsSummary() {
        var selected = state.detailed && state.detailed.metrics ? state.detailed.metrics.slice() : [];
        if (!selected.length) {
          return 'Nenhuma métrica';
        }
        var labels = selected.map(function (key) {
          var meta = getDetailedMetricMeta(key);
          return meta ? meta.label : key;
        });
        if (labels.length <= 2) {
          return labels.join(', ');
        }
        return labels.slice(0, 2).join(', ') + ' +' + (labels.length - 2);
      }

      function buildDetailedMetricsDropdown() {
        var wrapper = document.createElement('div');
        wrapper.className = 'relative';
        var button = document.createElement('button');
        button.type = 'button';
        button.className = 'inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-700/60 bg-slate-900/40 text-xs font-semibold text-slate-200 hover:border-sky-500/60 hover:text-white transition-colors';
        var summaryText = buildDetailedMetricsSummary();
        button.title = 'Selecione as métricas exibidas no gráfico. Atuais: ' + summaryText;
        var label = document.createElement('span');
        label.className = 'text-xs font-semibold text-slate-200 truncate max-w-[14rem]';
        label.textContent = 'Métricas: ' + summaryText;
        button.appendChild(label);
        var caret = document.createElement('span');
        caret.className = 'text-slate-400 text-sm';
        caret.textContent = '▾';
        button.appendChild(caret);
        wrapper.appendChild(button);

        var menu = document.createElement('div');
        menu.className = 'absolute right-0 mt-2 w-64 rounded-xl border border-slate-700/70 bg-slate-900/95 shadow-xl p-3 space-y-3 hidden z-30';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between';
        var menuTitle = document.createElement('span');
        menuTitle.className = 'text-xs font-semibold text-slate-200';
        menuTitle.textContent = 'Métricas disponíveis';
        header.appendChild(menuTitle);
        var helper = document.createElement('span');
        helper.className = 'text-[0.65rem] text-slate-400';
        helper.textContent = 'Escolha ao menos uma opção';
        header.appendChild(helper);
        menu.appendChild(header);

        DETAILED_METRICS.forEach(function (metric) {
          var isSelected = state.detailed.metrics.indexOf(metric.key) !== -1;
          var option = document.createElement('label');
          option.className = 'flex items-center justify-between gap-3 px-3 py-2 rounded-lg border transition-colors cursor-pointer';
          option.classList.add('border-transparent');
          if (isSelected) {
            option.classList.add('bg-sky-500/10', 'border-sky-500/60');
          } else {
            option.classList.add('hover:border-slate-700/70', 'hover:bg-slate-800/60');
          }
          var name = document.createElement('span');
          name.className = 'text-xs text-slate-200';
          name.textContent = metric.label;
          option.appendChild(name);
          var checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = isSelected;
          checkbox.className = 'h-4 w-4 text-sky-500';
          checkbox.addEventListener('change', function () {
            toggleDetailedMetric(metric.key, checkbox.checked);
          });
          option.appendChild(checkbox);
          menu.appendChild(option);
        });

        wrapper.appendChild(menu);

        button.addEventListener('click', function (ev) {
          ev.preventDefault();
          ev.stopPropagation();
          var willOpen = menu.classList.contains('hidden');
          cleanupDetailedMetricMenu();
          if (willOpen) {
            menu.classList.remove('hidden');
            var handleOutside = function (event) {
              if (!wrapper.contains(event.target)) {
                cleanupDetailedMetricMenu();
              }
            };
            var handleEscape = function (event) {
              if (event.key === 'Escape') {
                cleanupDetailedMetricMenu();
              }
            };
            state.detailedMetricMenuCleanup = function () {
              document.removeEventListener('click', handleOutside);
              document.removeEventListener('keydown', handleEscape);
              menu.classList.add('hidden');
            };
            document.addEventListener('click', handleOutside);
            document.addEventListener('keydown', handleEscape);
          }
        });

        return wrapper;
      }

      function renderDetailedSummaryCard(detailed, items) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between flex-wrap gap-3';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Resumo das seleções';
        header.appendChild(title);
        if (items.length) {
          var hint = document.createElement('span');
          hint.className = 'text-xs text-slate-400';
          hint.textContent = 'Valores ajustados por RevShare';
          header.appendChild(hint);
        }
        card.appendChild(header);
        if (!items.length) {
          var empty = document.createElement('div');
          empty.className = 'text-sm text-slate-400';
          empty.textContent = 'Selecione pelo menos uma ' + (state.detailed.mode === 'url' ? 'URL' : 'site') + ' para analisar.';
          card.appendChild(empty);
          return card;
        }
        var table = document.createElement('div');
        table.className = 'overflow-auto';
        var html = '';
        html += '<table class="w-full text-sm min-w-max">';
        html += '<thead class="text-slate-200">';
        if (state.detailed.mode === 'url') {
          html += '<tr>' +
            '<th class="px-3 py-2 text-left font-semibold">URL</th>' +
            '<th class="px-3 py-2 text-left font-semibold">Site</th>' +
            '<th class="px-3 py-2 text-right font-semibold">Sessões</th>' +
            '<th class="px-3 py-2 text-right font-semibold">Receita ($)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">RPS ($)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">Cobertura (%)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">eCPM ($)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">eCPM Efetivo ($)</th>' +
            '</tr>';
        } else {
          html += '<tr>' +
            '<th class="px-3 py-2 text-left font-semibold">Site</th>' +
            '<th class="px-3 py-2 text-right font-semibold">Sessões</th>' +
            '<th class="px-3 py-2 text-right font-semibold">Receita ($)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">RPS ($)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">Cobertura (%)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">eCPM ($)</th>' +
            '<th class="px-3 py-2 text-right font-semibold">eCPM Efetivo ($)</th>' +
            '</tr>';
        }
        html += '</thead><tbody class="divide-y divide-slate-800/60">';
        items.forEach(function (item) {
          var totals = item.totals || {};
          if (state.detailed.mode === 'url') {
            html += '<tr>' +
              '<td class="px-3 py-2 text-sky-300 break-all">' + escapeHtml(item.url || '') + '</td>' +
              '<td class="px-3 py-2 text-slate-300">' + escapeHtml(item.site || '') + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatNumber(totals.sessions) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.revenue) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.rps) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatPercent(totals.coverage) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.ecpm) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.effectiveEcpm) + '</td>' +
              '</tr>';
          } else {
            html += '<tr>' +
              '<td class="px-3 py-2 text-slate-200 font-medium">' + escapeHtml(item.site || '') + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatNumber(totals.sessions) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.revenue) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.rps) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatPercent(totals.coverage) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.ecpm) + '</td>' +
              '<td class="px-3 py-2 text-right">' + formatCurrency(totals.effectiveEcpm) + '</td>' +
              '</tr>';
          }
        });
        var combined = computeDetailedTotals(items);
        html += '<tr class="bg-slate-900/60 text-slate-100 font-semibold">' +
          (state.detailed.mode === 'url' ? '<td class="px-3 py-2">Total selecionado</td><td class="px-3 py-2"></td>' : '<td class="px-3 py-2">Total selecionado</td>') +
          '<td class="px-3 py-2 text-right">' + formatNumber(combined.sessions) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(combined.revenue) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(combined.rps) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatPercent(combined.coverage) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(combined.ecpm) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(combined.effectiveEcpm) + '</td>' +
          '</tr>';
        html += '</tbody></table>';
        table.innerHTML = html;
        card.appendChild(table);
        return card;
      }

      function computeDetailedTotals(items) {
        var totals = {
          sessions: 0,
          revenue: 0,
          mobTopRequests: 0,
          mobTopCoverageWeighted: 0,
          mobTopAdjustedEcpmWeighted: 0
        };
        items.forEach(function (item) {
          var data = item.totals || {};
          totals.sessions += Number(data.sessions || 0);
          totals.revenue += Number(data.revenue || 0);
          totals.mobTopRequests += Number(data.mobTopRequests || 0);
          totals.mobTopCoverageWeighted += Number(data.mobTopCoverageWeighted || 0);
          totals.mobTopAdjustedEcpmWeighted += Number(data.mobTopAdjustedEcpmWeighted || 0);
        });
        var coverageRatio = totals.mobTopRequests ? totals.mobTopCoverageWeighted / totals.mobTopRequests : 0;
        var ecpm = totals.mobTopRequests ? totals.mobTopAdjustedEcpmWeighted / totals.mobTopRequests : 0;
        return {
          sessions: totals.sessions,
          revenue: totals.revenue,
          rps: computeRpsValue(totals.revenue, totals.sessions),
          coverage: coverageRatio * 100,
          ecpm: ecpm,
          effectiveEcpm: ecpm * coverageRatio
        };
      }

      function renderDetailedChartCard(detailed, items) {
        cleanupDetailedMetricMenu();
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex flex-wrap items-start justify-between gap-3';
        var heading = document.createElement('div');
        heading.className = 'flex flex-col gap-1';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Série temporal das métricas selecionadas';
        heading.appendChild(title);
        var legend = document.createElement('span');
        legend.className = 'text-xs text-slate-400';
        legend.textContent = 'Cada linha representa a métrica escolhida por item';
        heading.appendChild(legend);
        header.appendChild(heading);
        var actions = document.createElement('div');
        actions.className = 'flex items-center gap-2';
        actions.appendChild(buildDetailedMetricsDropdown());
        header.appendChild(actions);
        card.appendChild(header);
        if (!detailed.hours || !detailed.hours.length) {
          var empty = document.createElement('div');
          empty.className = 'text-sm text-slate-400';
          empty.textContent = 'Sem recortes horários suficientes para gerar o gráfico.';
          card.appendChild(empty);
          return card;
        }
        var container = document.createElement('div');
        container.className = 'relative w-full rounded-2xl border border-slate-800/60 bg-slate-900/30 overflow-hidden';
        container.style.height = '420px';
        container.style.minHeight = '420px';
        container.style.maxHeight = '420px';
        var canvas = document.createElement('canvas');
        canvas.className = 'w-full h-full';
        canvas.height = 420;
        container.appendChild(canvas);
        card.appendChild(container);
        updateDetailedChart(canvas, detailed, items);
        return card;
      }

      function updateDetailedChart(canvas, detailed, items) {
        if (state.detailedChart) {
          state.detailedChart.destroy();
          state.detailedChart = null;
        }
        if (!items.length || !detailed.hours || !detailed.hours.length) {
          return;
        }
        var metricKeys = state.detailed.metrics && state.detailed.metrics.length ? state.detailed.metrics.slice() : ['revenue'];
        var labels = detailed.hours.map(function (hour) { return hour.label; });
        var datasets = [];
        items.forEach(function (item, itemIndex) {
          metricKeys.forEach(function (metricKey, metricIndex) {
            var colorIndex = (itemIndex * metricKeys.length + metricIndex) % DETAILED_COLORS.length;
            var color = DETAILED_COLORS[colorIndex];
            var hourValues = detailed.hours.map(function (hour) {
              var data = getDetailedHourData(item, hour.key);
              return Number(data[metricKey] || 0);
            });
            datasets.push({
              label: buildDetailedDatasetLabel(item, metricKey),
              data: hourValues,
              borderColor: color,
              backgroundColor: hexToRgba(color, 0.25),
              borderWidth: 2,
              tension: 0.25,
              fill: false,
              spanGaps: true,
              detailedMetric: metricKey
            });
          });
        });
        if (!datasets.length) {
          return;
        }
        var context = canvas.getContext('2d');
        state.detailedChart = new Chart(context, {
          type: 'line',
          data: { labels: labels, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: '#cbd5f5',
                  boxWidth: 12
                }
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    var metric = context.dataset.detailedMetric;
                    var value = context.parsed.y;
                    return context.dataset.label + ': ' + formatDetailedMetricValue(metric, value);
                  }
                }
              },
              datalabels: {
                align: 'top',
                anchor: 'end',
                backgroundColor: function (context) {
                  var color = context.dataset && context.dataset.borderColor ? context.dataset.borderColor : '#38bdf8';
                  return hexToRgba(color, 0.55);
                },
                borderRadius: 6,
                clamp: true,
                color: '#e2e8f0',
                font: {
                  size: 10,
                  weight: '600'
                },
                formatter: function (value, context) {
                  if (value === null || typeof value === 'undefined') {
                    return '';
                  }
                  return formatDetailedMetricValue(context.dataset.detailedMetric, value);
                },
                offset: 6,
                padding: {
                  top: 2,
                  right: 4,
                  bottom: 2,
                  left: 4
                }
              }
            },
            scales: {
              x: {
                ticks: { color: '#94a3b8' },
                grid: { color: 'rgba(148, 163, 184, 0.15)' }
              },
              y: {
                ticks: {
                  color: '#94a3b8',
                  callback: function (value) {
                    return Number(value || 0).toLocaleString('pt-BR', { maximumFractionDigits: 2 });
                  }
                },
                grid: { color: 'rgba(148, 163, 184, 0.12)' }
              }
            }
          }
        });
      }

      function buildDetailedDatasetLabel(item, metricKey) {
        var meta = getDetailedMetricMeta(metricKey);
        var base = meta ? meta.label : metricKey;
        var name = state.detailed.mode === 'url' ? (item.url || '') : (item.site || '');
        return (name || 'Item') + ' • ' + base;
      }

      function getDetailedMetricMeta(metricKey) {
        for (var i = 0; i < DETAILED_METRICS.length; i++) {
          if (DETAILED_METRICS[i].key === metricKey) {
            return DETAILED_METRICS[i];
          }
        }
        return null;
      }

      function formatDetailedMetricValue(metricKey, value) {
        var meta = getDetailedMetricMeta(metricKey);
        if (!meta) {
          return Number(value || 0).toLocaleString('pt-BR', { maximumFractionDigits: 2 });
        }
        if (meta.type === 'currency') {
          return formatCurrency(value);
        }
        if (meta.type === 'percent') {
          return formatPercent(value);
        }
        return Number(value || 0).toLocaleString('pt-BR', { maximumFractionDigits: 0 });
      }

      function hexToRgba(hex, alpha) {
        if (!hex) return 'rgba(148, 163, 184, ' + (alpha != null ? alpha : 1) + ')';
        var sanitized = hex.replace('#', '');
        if (sanitized.length === 3) {
          sanitized = sanitized.split('').map(function (char) { return char + char; }).join('');
        }
        var bigint = parseInt(sanitized, 16);
        if (isNaN(bigint)) {
          return 'rgba(148, 163, 184, ' + (alpha != null ? alpha : 1) + ')';
        }
        var r = (bigint >> 16) & 255;
        var g = (bigint >> 8) & 255;
        var b = bigint & 255;
        var opacity = alpha != null ? alpha : 1;
        return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + opacity + ')';
      }

      function renderDetailedTimelineCard(detailed, items) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Evolução horária agregada';
        card.appendChild(title);
        if (!detailed.hours || !detailed.hours.length) {
          var empty = document.createElement('div');
          empty.className = 'text-sm text-slate-400';
          empty.textContent = 'Sem horas disponíveis para montar a série temporal.';
          card.appendChild(empty);
          return card;
        }
        var table = document.createElement('div');
        table.className = 'overflow-auto';
        var html = '';
        html += '<table class="w-full text-sm min-w-max">';
        html += '<thead class="text-slate-200">';
        html += '<tr>' +
          '<th class="px-3 py-2 text-left font-semibold">Hora</th>' +
          '<th class="px-3 py-2 text-right font-semibold">Sessões</th>' +
          '<th class="px-3 py-2 text-right font-semibold">Receita ($)</th>' +
          '<th class="px-3 py-2 text-right font-semibold">RPS ($)</th>' +
          '<th class="px-3 py-2 text-right font-semibold">Cobertura (%)</th>' +
          '<th class="px-3 py-2 text-right font-semibold">eCPM ($)</th>' +
          '<th class="px-3 py-2 text-right font-semibold">eCPM Efetivo ($)</th>' +
          '</tr>';
        html += '</thead><tbody class="divide-y divide-slate-800/60">';
        var timelineTotalsAccumulator = createDetailedTimelineAccumulator();
        detailed.hours.forEach(function (hour) {
          var aggregate = computeDetailedHourAggregate(items, hour.key);
          accumulateDetailedTimelineTotals(timelineTotalsAccumulator, aggregate);
          html += '<tr>' +
            '<td class="px-3 py-2 text-slate-200">' + escapeHtml(hour.label) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatNumber(aggregate.sessions) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(aggregate.revenue) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(aggregate.rps) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatPercent(aggregate.coverage) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(aggregate.ecpm) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(aggregate.effectiveEcpm) + '</td>' +
            '</tr>';
        });
        var timelineTotals = finalizeDetailedTimelineTotals(timelineTotalsAccumulator);
        html += '<tr class="bg-slate-900/60 text-slate-100 font-semibold">' +
          '<td class="px-3 py-2">Total</td>' +
          '<td class="px-3 py-2 text-right">' + formatNumber(timelineTotals.sessions) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(timelineTotals.revenue) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(timelineTotals.rps) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatPercent(timelineTotals.coverage) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(timelineTotals.ecpm) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(timelineTotals.effectiveEcpm) + '</td>' +
          '</tr>';
        html += '</tbody></table>';
        table.innerHTML = html;
        card.appendChild(table);
        return card;
      }

      function getDetailedHourData(item, hourKey) {
        if (!item || !item.hourly) {
          return {
            sessions: 0,
            revenue: 0,
            rps: 0,
            coverage: 0,
            ecpm: 0,
            effectiveEcpm: 0,
            mobTopRequests: 0,
            mobTopCoverageWeighted: 0,
            mobTopAdjustedEcpmWeighted: 0
          };
        }
        var direct = item.hourly[hourKey];
        if (direct) return direct;
        var stringKey = String(hourKey);
        if (item.hourly.hasOwnProperty(stringKey)) {
          return item.hourly[stringKey];
        }
        return {
          sessions: 0,
          revenue: 0,
          rps: 0,
          coverage: 0,
          ecpm: 0,
          effectiveEcpm: 0,
          mobTopRequests: 0,
          mobTopCoverageWeighted: 0,
          mobTopAdjustedEcpmWeighted: 0
        };
      }

      function computeDetailedHourAggregate(items, hourKey) {
        var totals = {
          sessions: 0,
          revenue: 0,
          mobTopRequests: 0,
          mobTopCoverageWeighted: 0,
          mobTopAdjustedEcpmWeighted: 0
        };
        items.forEach(function (item) {
          var hourData = getDetailedHourData(item, hourKey);
          totals.sessions += Number(hourData.sessions || 0);
          totals.revenue += Number(hourData.revenue || 0);
          totals.mobTopRequests += Number(hourData.mobTopRequests || 0);
          totals.mobTopCoverageWeighted += Number(hourData.mobTopCoverageWeighted || 0);
          totals.mobTopAdjustedEcpmWeighted += Number(hourData.mobTopAdjustedEcpmWeighted || 0);
        });
        var coverageRatio = totals.mobTopRequests ? totals.mobTopCoverageWeighted / totals.mobTopRequests : 0;
        var ecpm = totals.mobTopRequests ? totals.mobTopAdjustedEcpmWeighted / totals.mobTopRequests : 0;
        return {
          sessions: totals.sessions,
          revenue: totals.revenue,
          rps: computeRpsValue(totals.revenue, totals.sessions),
          coverage: coverageRatio * 100,
          ecpm: ecpm,
          effectiveEcpm: ecpm * coverageRatio
        };
      }

      function createDetailedTimelineAccumulator() {
        return {
          sessions: 0,
          revenue: 0,
          weightedRps: 0,
          weightedCoverage: 0,
          weightedEcpm: 0,
          weightedEffectiveEcpm: 0
        };
      }

      function accumulateDetailedTimelineTotals(accumulator, aggregate) {
        if (!accumulator || !aggregate) return;
        var sessions = Number(aggregate.sessions || 0);
        accumulator.sessions += sessions;
        accumulator.revenue += Number(aggregate.revenue || 0);
        accumulator.weightedRps += Number(aggregate.rps || 0) * sessions;
        accumulator.weightedCoverage += Number(aggregate.coverage || 0) * sessions;
        accumulator.weightedEcpm += Number(aggregate.ecpm || 0) * sessions;
        accumulator.weightedEffectiveEcpm += Number(aggregate.effectiveEcpm || 0) * sessions;
      }

      function finalizeDetailedTimelineTotals(accumulator) {
        if (!accumulator) {
          return {
            sessions: 0,
            revenue: 0,
            rps: 0,
            coverage: 0,
            ecpm: 0,
            effectiveEcpm: 0
          };
        }
        var totalSessions = accumulator.sessions || 0;
        var safeDivide = function (value) {
          if (!totalSessions) return 0;
          return value / totalSessions;
        };
        return {
          sessions: accumulator.sessions,
          revenue: accumulator.revenue,
          rps: safeDivide(accumulator.weightedRps),
          coverage: safeDivide(accumulator.weightedCoverage),
          ecpm: safeDivide(accumulator.weightedEcpm),
          effectiveEcpm: safeDivide(accumulator.weightedEffectiveEcpm)
        };
      }

      function renderDistributionView(distribution, wrapper) {
        if (!distribution) {
          var empty = document.createElement('div');
          empty.className = 'card rounded-2xl p-6 text-center text-slate-400';
          empty.textContent = 'Sem dados suficientes para sugerir distribuição inteligente.';
          wrapper.appendChild(empty);
          return;
        }
        normalizeDistributionEffectiveEcpm(distribution);
        if (distribution.requiresRouteSelection) {
          var notice = document.createElement('div');
          notice.className = 'card rounded-2xl p-6 space-y-3 text-slate-200';
          var title = document.createElement('h3');
          title.className = 'text-lg font-semibold text-slate-100';
          title.textContent = 'Selecione o slug da rota para visualizar a distribuição';
          notice.appendChild(title);
          var message = document.createElement('p');
          message.className = 'text-sm text-slate-300';
          message.textContent = 'Escolha uma rota no filtro "Rota (slug)" para carregar as sugestões de distribuição inteligente e os percentuais vinculados ao Link Router.';
          notice.appendChild(message);
          var hint = document.createElement('p');
          hint.className = 'text-xs text-slate-400';
          hint.textContent = 'As demais abas continuam disponíveis sem a seleção de rota.';
          notice.appendChild(hint);
          wrapper.appendChild(notice);
          return;
        }
        resolveDistributionSelection(distribution);
        var integration = state.analysis && state.analysis.integration ? state.analysis.integration : null;
        wrapper.appendChild(renderDistributionControlsCard(distribution, integration));
        var missingCard = renderDistributionMissingUrlsCard(distribution);
        if (missingCard) {
          wrapper.appendChild(missingCard);
        }
        wrapper.appendChild(renderDistributionSitesCard(distribution));
        var globalCard = renderDistributionGlobalUrlsCard(distribution);
        if (globalCard) {
          wrapper.appendChild(globalCard);
        }
        wrapper.appendChild(renderDistributionUrlsCard(distribution));
      }

      function renderDistributionControlsCard(distribution, integration) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between flex-wrap gap-3';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Controles globais da distribuição';
        header.appendChild(title);
        if (state.distribution.dirty) {
          var badge = document.createElement('span');
          badge.className = 'inline-flex items-center gap-1 text-xs font-semibold text-amber-300 bg-amber-500/10 border border-amber-400/40 px-3 py-1 rounded-full';
          badge.innerHTML = '<svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 2.75a.75.75 0 00-1.5 0v6.728l-3.614 3.613a.75.75 0 101.06 1.06l4-4A.75.75 0 0010.75 9.75V2.75z"/><path d="M4.25 13a.75.75 0 10-1.5 0v2.25A2.75 2.75 0 005.5 18h9a2.75 2.75 0 002.75-2.75V13a.75.75 0 10-1.5 0v2.25c0 .69-.56 1.25-1.25 1.25h-9c-.69 0-1.25-.56-1.25-1.25V13z"/></svg> Ajustes pendentes';
          header.appendChild(badge);
        }
        card.appendChild(header);

        card.appendChild(renderDistributionIntegrationSummary(integration));

        var params = (state.distribution && state.distribution.params) || distribution.controls || {};
        var fields = [
          { key: 'urlSeedPercent', label: 'Share mínimo URL (%)', percent: true, step: 0.1, min: 0, decimals: 1 },
          { key: 'urlMinRecipients', label: 'URLs prioritárias', type: 'number', step: 1, min: 0, decimals: 0 },
          { key: 'urlPriorityShare', label: 'Share URLs prioritárias (%)', percent: true, step: 1, min: 0, decimals: 1 },
          { key: 'urlTargetRecipients', label: 'URLs ativas (limite)', type: 'number', step: 1, min: 0, decimals: 0 },
          { key: 'modeThresholdRps', label: 'Limite RPS modo apostas ($)', type: 'number', step: 10, min: 0, decimals: 0 },
          { key: 'controlReserve', label: 'Reserva controle (%)', percent: true, step: 0.5, min: 0, decimals: 1 },
          { key: 'betMinShare', label: 'Share mínimo por URL aposta (%)', percent: true, step: 0.5, min: 0, decimals: 1 }
        ];

        var grid = document.createElement('div');
        grid.className = 'grid gap-4 md:grid-cols-2 xl:grid-cols-4';
        fields.forEach(function (field) {
          var wrapper = document.createElement('label');
          wrapper.className = 'flex flex-col gap-1 text-sm text-slate-300';
          wrapper.textContent = field.label;
          var input = document.createElement('input');
          input.type = field.type || 'number';
          input.className = 'pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100';
          if (field.step != null) input.step = field.step;
          if (field.min != null) input.min = field.min;
          if (field.max != null) input.max = field.max;
          var value = params[field.key];
          if (value != null && value !== '') {
            var numeric = Number(value);
            if (field.percent) {
              numeric = numeric * 100;
            }
            var decimals = field.decimals != null ? field.decimals : 2;
            input.value = numeric.toFixed(decimals);
          }
          input.addEventListener('change', function (ev) {
            var raw = parseFloat(ev.target.value);
            if (isNaN(raw)) return;
            var normalized = field.percent ? raw / 100 : raw;
            updateDistributionParam(field.key, normalized);
            renderAnalysis();
          });
          wrapper.appendChild(input);
          grid.appendChild(wrapper);
        });
        card.appendChild(grid);

        var minimumsCard = renderDistributionMinimumsSection(distribution);
        if (minimumsCard) {
          card.appendChild(minimumsCard);
        }

        var toggleRow = document.createElement('div');
        toggleRow.className = 'flex flex-wrap items-center justify-between gap-3 text-sm text-slate-300';
        var requireLabel = document.createElement('label');
        requireLabel.className = 'inline-flex items-center gap-2';
        var requireInput = document.createElement('input');
        requireInput.type = 'checkbox';
        requireInput.checked = !!params.urlRequireAll;
        requireInput.addEventListener('change', function (ev) {
          updateDistributionParam('urlRequireAll', ev.target.checked ? 1 : 0);
          renderAnalysis();
        });
        requireLabel.appendChild(requireInput);
        var requireText = document.createElement('span');
        requireText.textContent = 'Garantir tráfego em todas as URLs';
        requireLabel.appendChild(requireText);
        toggleRow.appendChild(requireLabel);
        var toggleHint = document.createElement('p');
        toggleHint.className = 'text-xs text-slate-400';
        toggleHint.textContent = 'Quando desativado, apenas as URLs prioritárias recebem o tráfego mínimo configurado.';
        toggleRow.appendChild(toggleHint);
        card.appendChild(toggleRow);

        var buttonsRow = document.createElement('div');
        buttonsRow.className = 'flex flex-wrap items-center justify-between gap-3';
        var applyButton = document.createElement('button');
        applyButton.type = 'button';
        applyButton.id = 'btn-distribuicao-aplicar';
        applyButton.className = 'inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-5 py-2.5 rounded-xl shadow-lg shadow-emerald-900/40 transition-all';
        applyButton.innerHTML = '<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Recalcular plano';
        applyButton.addEventListener('click', function (ev) {
          ev.preventDefault();
          recalcularDistribuicao();
        });
        buttonsRow.appendChild(applyButton);

        var syncButton = document.createElement('button');
        syncButton.type = 'button';
        syncButton.id = 'btn-distribuicao-sincronizar';
        syncButton.className = 'inline-flex items-center gap-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold px-5 py-2.5 rounded-xl shadow-lg shadow-sky-900/40 transition-all';
        var canSync = integration && integration.companyId && integration.domainId && integration.routeSlug;
        var isSyncing = !!state.syncingLinkRouter;
        if (isSyncing) {
          syncButton.innerHTML = '<svg class="w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992m-5.614 3.72l3.536 3.536m-6.366-.964v4.992m-3.72-5.614l-3.536 3.536m.964-6.366H1.287m5.614-3.72L3.365 5.466m6.366.964V1.438m3.72 5.614l3.536-3.536" /></svg>Sincronizando...';
        } else {
          syncButton.innerHTML = '<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992m-5.614 3.72l3.536 3.536m-6.366-.964v4.992m-3.72-5.614l-3.536 3.536m.964-6.366H1.287m5.614-3.72L3.365 5.466m6.366.964V1.438m3.72 5.614l3.536-3.536" /></svg>Sincronizar com API';
        }
        if (!canSync) {
          syncButton.disabled = true;
          syncButton.classList.add('opacity-60', 'cursor-not-allowed');
          syncButton.title = 'Configure a integração do Link Router na aba Configuração.';
        }
        if (isSyncing) {
          syncButton.disabled = true;
          syncButton.classList.add('opacity-60', 'cursor-not-allowed');
        } else if (canSync) {
          syncButton.addEventListener('click', function (ev) {
            ev.preventDefault();
            sincronizarDistribuicao();
          });
        }
        buttonsRow.appendChild(syncButton);
        card.appendChild(buttonsRow);

        var summary = document.createElement('p');
        summary.className = 'text-xs text-slate-400';
        summary.textContent = 'Plano atual considera ' + formatNumber(distribution.totalSessions || 0) + ' sessões observadas na janela selecionada.';
        card.appendChild(summary);

        return card;
      }

      function renderDistributionMinimumsSection(distribution) {
        ensureDistributionState();
        var minimums = getDistributionMinimums();
        var options = collectDistributionUrlOptions(distribution);
        var optionLookup = {};
        options.forEach(function (option) {
          if (!option || !option.url) return;
          optionLookup[option.url.toLowerCase()] = option;
        });

        var datalistId = 'distribution-minimum-url-options';
        var existingList = document.getElementById(datalistId);
        if (existingList) {
          existingList.remove();
        }

        var container = document.createElement('div');
        container.className = 'rounded-xl border border-slate-800/70 bg-slate-900/40 p-4 space-y-4';

        var header = document.createElement('div');
        header.className = 'flex flex-wrap items-center justify-between gap-2';
        var titleWrap = document.createElement('div');
        titleWrap.className = 'flex flex-col gap-1';
        var title = document.createElement('h4');
        title.className = 'text-sm font-semibold text-slate-200';
        title.textContent = 'URLs com distribuição mínima garantida';
        titleWrap.appendChild(title);
        var hint = document.createElement('p');
        hint.className = 'text-xs text-slate-400';
        hint.textContent = 'Reserve uma parcela mínima do tráfego para URLs específicas da rota atual.';
        titleWrap.appendChild(hint);
        header.appendChild(titleWrap);

        var addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-700/70 bg-slate-800/70 text-sm text-slate-100 hover:bg-slate-800/90 transition-colors';
        addButton.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>Adicionar URL';
        addButton.addEventListener('click', function (ev) {
          ev.preventDefault();
          if (addDistributionMinimum(options)) {
            renderAnalysis();
          }
        });
        header.appendChild(addButton);
        container.appendChild(header);

        var datalist = document.createElement('datalist');
        datalist.id = datalistId;
        options.forEach(function (option) {
          if (!option || !option.url) return;
          var opt = document.createElement('option');
          opt.value = option.url;
          if (option.site) {
            opt.label = option.site;
          }
          datalist.appendChild(opt);
        });
        container.appendChild(datalist);

        var listWrapper = document.createElement('div');
        listWrapper.className = 'space-y-3';
        if (!minimums.length) {
          var empty = document.createElement('p');
          empty.className = 'text-xs text-slate-400';
          empty.textContent = 'Nenhuma URL configurada. Clique em "Adicionar URL" para garantir participação mínima.';
          listWrapper.appendChild(empty);
        } else {
          minimums.forEach(function (entry, index) {
            var row = document.createElement('div');
            row.className = 'flex flex-col md:flex-row md:items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-900/60 p-3';

            var urlWrapper = document.createElement('div');
            urlWrapper.className = 'flex-1 flex flex-col gap-1';
            var urlLabel = document.createElement('span');
            urlLabel.className = 'text-xs uppercase tracking-wide text-slate-400';
            urlLabel.textContent = 'URL';
            urlWrapper.appendChild(urlLabel);
            var urlInput = document.createElement('input');
            urlInput.type = 'text';
            urlInput.className = 'pill px-3 py-2 rounded-lg bg-slate-950/60 text-sm text-slate-100';
            urlInput.placeholder = 'https://exemplo.com/...';
            urlInput.setAttribute('list', datalistId);
            urlInput.value = entry.url || '';
            urlInput.addEventListener('change', function (ev) {
              var previous = entry.url || '';
              var value = (ev.target.value || '').trim();
              if (!value) {
                if (updateDistributionMinimum(index, { url: '', site: '' })) {
                  renderAnalysis();
                }
                return;
              }
              if (hasDistributionMinimumUrl(value, index)) {
                showToast('Esta URL já possui um percentual mínimo configurado.', 'error');
                ev.target.value = previous;
                return;
              }
              var match = optionLookup[value.toLowerCase()] || null;
              var site = match && match.site ? match.site : '';
              if (updateDistributionMinimum(index, { url: value, site: site })) {
                renderAnalysis();
              }
            });
            urlWrapper.appendChild(urlInput);
            var siteInfo = document.createElement('span');
            siteInfo.className = 'text-xs text-slate-400';
            siteInfo.textContent = entry.site ? 'Site: ' + entry.site : 'Site: —';
            urlWrapper.appendChild(siteInfo);
            row.appendChild(urlWrapper);

            var shareWrapper = document.createElement('div');
            shareWrapper.className = 'flex flex-col gap-1 w-full md:w-36';
            var shareLabel = document.createElement('span');
            shareLabel.className = 'text-xs uppercase tracking-wide text-slate-400';
            shareLabel.textContent = 'Percentual mínimo (%)';
            shareWrapper.appendChild(shareLabel);
            var shareInput = document.createElement('input');
            shareInput.type = 'number';
            shareInput.step = '0.1';
            shareInput.min = '0';
            shareInput.max = '100';
            shareInput.className = 'pill px-3 py-2 rounded-lg bg-slate-950/60 text-sm text-slate-100 text-right';
            var percentValue = Number(entry.share || 0) * 100;
            shareInput.value = percentValue ? percentValue.toFixed(2) : '0.00';
            shareInput.addEventListener('change', function (ev) {
              var raw = parseFloat(ev.target.value);
              if (isNaN(raw)) raw = 0;
              if (raw < 0) raw = 0;
              if (raw > 100) raw = 100;
              var formatted = raw.toFixed(2);
              ev.target.value = formatted;
              var decimal = Math.round((raw / 100) * 1e6) / 1e6;
              if (updateDistributionMinimum(index, { share: decimal })) {
                renderAnalysis();
              }
            });
            shareWrapper.appendChild(shareInput);
            row.appendChild(shareWrapper);

            var actions = document.createElement('div');
            actions.className = 'flex items-center md:items-start md:flex-col gap-2';
            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'inline-flex items-center gap-1 text-xs text-rose-300 hover:text-rose-200 px-2 py-1 rounded-lg hover:bg-rose-500/10 transition-colors';
            removeButton.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>Remover';
            removeButton.addEventListener('click', function (ev) {
              ev.preventDefault();
              if (removeDistributionMinimum(index)) {
                renderAnalysis();
              }
            });
            actions.appendChild(removeButton);
            row.appendChild(actions);

            listWrapper.appendChild(row);
          });
        }
        container.appendChild(listWrapper);

        var totalShare = minimums.reduce(function (acc, entry) {
          if (!entry || !entry.url) return acc;
          var share = Number(entry.share || 0);
          if (isNaN(share)) return acc;
          return acc + share;
        }, 0);

        var summaryRow = document.createElement('div');
        summaryRow.className = 'flex flex-wrap items-center justify-between gap-2 text-xs';
        var totalEl = document.createElement('span');
        totalEl.className = 'text-slate-300';
        totalEl.textContent = 'Total mínimo reservado: ' + formatShare(totalShare || 0);
        summaryRow.appendChild(totalEl);
        if (totalShare > 1) {
          var warning = document.createElement('span');
          warning.className = 'text-amber-300';
          warning.textContent = 'A soma ultrapassa 100% do tráfego disponível. Ajuste os percentuais.';
          summaryRow.appendChild(warning);
        } else {
          var info = document.createElement('span');
          info.className = 'text-slate-400';
          info.textContent = 'O sistema ainda pode alocar mais tráfego conforme o desempenho das URLs.';
          summaryRow.appendChild(info);
        }
        container.appendChild(summaryRow);

        if (distribution && distribution.fixedMinimumsInfo) {
          var infoBlock = document.createElement('div');
          infoBlock.className = 'text-xs text-slate-400 space-y-1';
          var appliedShare = Number(distribution.fixedMinimumsInfo.appliedShare || 0);
          if (appliedShare > 0) {
            var appliedEl = document.createElement('p');
            appliedEl.textContent = 'Plano atual reserva ao menos ' + formatShare(appliedShare) + ' antes de aplicar as demais regras.';
            infoBlock.appendChild(appliedEl);
          }
          var unmatched = Array.isArray(distribution.fixedMinimumsInfo.unmatched)
            ? distribution.fixedMinimumsInfo.unmatched.filter(function (item) { return item && item.url; })
            : [];
          if (unmatched.length) {
            var preview = unmatched.slice(0, 3).map(function (item) {
              var parts = [item.url];
              if (item.share != null) {
                parts.push(formatShare(item.share));
              }
              return parts.join(' • ');
            }).join(', ');
            var extraCount = unmatched.length - Math.min(unmatched.length, 3);
            var unmatchedEl = document.createElement('p');
            unmatchedEl.className = 'text-amber-200';
            unmatchedEl.textContent = 'URLs sem correspondência nos dados recentes: ' + preview + (extraCount > 0 ? ' +' + extraCount + ' outras' : '');
            infoBlock.appendChild(unmatchedEl);
          }
          if (infoBlock.childElementCount) {
            container.appendChild(infoBlock);
          }
        }

        var actionsRow = document.createElement('div');
        actionsRow.className = 'flex justify-end';
        var saveButton = document.createElement('button');
        saveButton.type = 'button';
        saveButton.className = 'mt-2 inline-flex items-center gap-2 bg-sky-600 hover:bg-sky-500 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow-lg shadow-sky-900/40 transition-colors';
        saveButton.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Salvar percentuais mínimos';
        saveButton.addEventListener('click', function (ev) {
          ev.preventDefault();
          salvarDistribuicaoMinimos();
        });
        actionsRow.appendChild(saveButton);
        container.appendChild(actionsRow);

        return container;
      }

      function renderDistributionMissingUrlsCard(distribution) {
        if (!distribution || !distribution.missingRouteLinks || !distribution.missingRouteLinks.length) {
          return null;
        }
        var missing = distribution.missingRouteLinks;
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-amber-200';
        title.textContent = 'URLs da rota sem dados recentes na base';
        card.appendChild(title);
        var description = document.createElement('p');
        description.className = 'text-sm text-slate-300';
        description.textContent = 'Essas URLs estão configuradas no Link Router, mas não registraram sessões no período analisado. Os percentuais atuais foram mantidos e não são alterados pelo plano sugerido.';
        card.appendChild(description);
        if (distribution.missingRouteShare != null && distribution.missingRouteShare > 0) {
          var reservedInfo = document.createElement('p');
          reservedInfo.className = 'text-xs text-amber-200';
          var reservedShare = formatShare(distribution.missingRouteShare || 0);
          var availableShare = formatShare(distribution.availableRouteShare != null ? distribution.availableRouteShare : (1 - (distribution.missingRouteShare || 0)));
          reservedInfo.textContent = 'Tráfego reservado para essas URLs: ' + reservedShare + '. Plano distribui os ' + availableShare + ' restantes.';
          card.appendChild(reservedInfo);
        }
        var list = document.createElement('ul');
        list.className = 'space-y-2 text-sm text-slate-200 list-disc list-inside';
        var maxItems = 10;
        missing.slice(0, maxItems).forEach(function (entry) {
          var item = document.createElement('li');
          var parts = [];
          parts.push(entry.url || '-');
          var shareValue = null;
          if (entry.share != null && !isNaN(entry.share)) {
            shareValue = entry.share;
          } else if (entry.percentage != null && !isNaN(entry.percentage)) {
            shareValue = entry.percentage / 100;
          }
          if (shareValue != null) {
            parts.push('Percentual atual: ' + formatShare(shareValue));
          }
          item.textContent = parts.join(' • ');
          list.appendChild(item);
        });
        card.appendChild(list);
        if (missing.length > maxItems) {
          var extra = document.createElement('p');
          extra.className = 'text-xs text-slate-400';
          extra.textContent = '... e mais ' + (missing.length - maxItems) + ' URL(s) sem dados.';
          card.appendChild(extra);
        }
        var hint = document.createElement('p');
        hint.className = 'text-xs text-slate-400';
        hint.textContent = 'Cadastre essas URLs na aba Configuração ou aguarde novos dados para incluí-las no plano.';
        card.appendChild(hint);
        return card;
      }

      function renderDistributionIntegrationSummary(integration) {
        var container = document.createElement('div');
        container.className = 'rounded-xl border border-slate-700/60 bg-slate-900/40 p-4 space-y-3';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between flex-wrap gap-2';
        var title = document.createElement('span');
        title.className = 'text-sm font-semibold text-slate-200';
        title.textContent = 'Integração Link Router';
        header.appendChild(title);
        var status = document.createElement('span');
        status.className = 'inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold border ';
        var configured = !!integration;
        var active = configured && !!integration.active;
        var statusIcon = '';
        var statusText = '';
        if (active) {
          status.className += 'bg-emerald-500/15 text-emerald-300 border-emerald-400/40';
          statusIcon = '<svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>';
          statusText = 'Automação ativa';
        } else if (configured) {
          status.className += 'bg-amber-500/15 text-amber-200 border-amber-400/40';
          statusIcon = '<svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9v6.75m4.5-6.75V15.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
          statusText = 'Automação inativa';
        } else {
          status.className += 'bg-slate-800/60 text-slate-300 border-slate-600/50';
          statusIcon = '<svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6" /></svg>';
          statusText = 'Integração não configurada';
        }
        status.innerHTML = statusIcon + statusText;
        header.appendChild(status);
        container.appendChild(header);

        var createDetail = function (label, value) {
          var block = document.createElement('div');
          var labelEl = document.createElement('span');
          labelEl.className = 'text-[0.65rem] uppercase tracking-wide text-slate-500';
          labelEl.textContent = label;
          block.appendChild(labelEl);
          var valueEl = document.createElement('span');
          valueEl.className = 'block text-sm font-semibold text-slate-200 break-all';
          valueEl.textContent = value || '—';
          block.appendChild(valueEl);
          return block;
        };

        if (configured) {
          var grid = document.createElement('div');
          grid.className = 'grid gap-3 sm:grid-cols-2 lg:grid-cols-4 text-xs text-slate-300';
          grid.appendChild(createDetail('Operação', integration.operation || '—'));
          grid.appendChild(createDetail('Empresa ID', integration.companyId || '—'));
          grid.appendChild(createDetail('Domínio ID', integration.domainId || '—'));
          grid.appendChild(createDetail('Slug rota', integration.routeSlug || '—'));
          container.appendChild(grid);

          var hint = document.createElement('p');
          hint.className = 'text-xs text-slate-400';
          hint.textContent = active ? 'Sincronização automática com o Link Router executará a cada 1h.' : 'Ative a automação para sincronizar as porcentagens a cada 1h.';
          container.appendChild(hint);
        } else {
          var message = document.createElement('p');
          message.className = 'text-xs text-slate-400';
          message.textContent = 'Configure a integração na aba Configuração para habilitar o envio automático ao Link Router.';
          container.appendChild(message);
        }

        return container;
      }

      function renderDistributionSitesCard(distribution) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between gap-3 flex-wrap';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Sugestão por Site';
        header.appendChild(title);
        card.appendChild(header);
        var rows = distribution && distribution.sites ? distribution.sites : [];
        if (!rows.length) {
          var empty = document.createElement('div');
          empty.className = 'text-sm text-slate-400';
          empty.textContent = 'Sem sites suficientes para sugerir distribuição.';
          card.appendChild(empty);
          return card;
        }
        var sortedRows = sortDistributionSiteRows(rows);
        var tableWrap = document.createElement('div');
        tableWrap.className = 'overflow-auto';
        var html = '';
        html += '<table class="w-full text-sm min-w-max">';
        html += '<thead class="text-slate-300 table-head-sticky">';
        html += '<tr>' +
          '<th class="px-3 py-2 text-left font-semibold">' + buildSortHeader('distributionSites', 'site', 'Site', 'left') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'rps', 'RPS ($)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'coverage', 'Cobertura (%)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'ecpmEff', 'eCPM Efetivo ($)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'momentum', 'Tendência (1h)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'confidence', 'Confiab.', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'currentShare', '% Atual', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'suggestedShare', '% Sugerida', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionSites', 'deltaShare', 'Δ%', 'right') + '</th>' +
          '<th class="px-3 py-2 text-center font-semibold">' + buildSortHeader('distributionSites', 'mode', 'Modo', 'center') + '</th>' +
          '<th class="px-3 py-2 text-left font-semibold">' + buildSortHeader('distributionSites', 'nextEvaluation', 'Próx. Reavaliação', 'left') + '</th>' +
          '</tr>';
        html += '</thead><tbody class="divide-y divide-slate-800/60">';
        sortedRows.forEach(function (row) {
          var selected = state.distribution.selectedSite === row.site;
          var rowClass = selected ? 'bg-sky-900/30 text-slate-100' : '';
          var effectiveEcpm = computeEffectiveEcpm(row);
          html += '<tr class="cursor-pointer ' + rowClass + '" data-site-select="' + escapeHtml(row.site) + '">';
          html += '<td class="px-3 py-2 font-semibold text-slate-100">' + escapeHtml(row.site) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatCurrency(row.rps) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatPercent(row.coverage) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatCurrency(effectiveEcpm) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatTrend(row.momentum) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatPercent(row.confidence * 100) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatShare(row.currentShare) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatShare(row.suggestedShare) + '</td>';
          html += '<td class="px-3 py-2 text-right">' + formatDeltaShare(row.deltaShare) + '</td>';
          html += '<td class="px-3 py-2 text-center"><span class="px-2 py-1 rounded-full text-xs ' + (row.mode === 'Apostas' ? 'bg-amber-500/10 text-amber-200 border border-amber-400/40' : 'bg-sky-500/10 text-sky-200 border border-sky-400/30') + '">' + escapeHtml(row.mode) + '</span></td>';
          html += '<td class="px-3 py-2 text-left text-slate-300">' + escapeHtml(row.nextEvaluation || '-') + '</td>';
          html += '</tr>';
        });
        html += '</tbody></table>';
        tableWrap.innerHTML = html;
        card.appendChild(tableWrap);
        attachSortHandlers(card);
        tableWrap.addEventListener('click', function (ev) {
          var target = ev.target.closest('[data-site-select]');
          if (!target) return;
          var site = target.getAttribute('data-site-select');
          if (!site) return;
          state.distribution.selectedSite = site;
          renderAnalysis();
        });
        return card;
      }

      function renderDistributionGlobalUrlsCard(distribution) {
        if (!distribution || !distribution.globalUrls) {
          return null;
        }
        var summary = distribution.globalUrls;
        var entries = (summary.entries && summary.entries.length ? summary.entries : (summary.all || [])).slice();
        if (!entries.length) {
          return null;
        }
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex flex-wrap items-center justify-between gap-3';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Resumo global por URL';
        header.appendChild(title);
        var infoWrap = document.createElement('div');
        infoWrap.className = 'flex flex-wrap items-center gap-3 text-sm text-slate-300';
        var average = document.createElement('span');
        average.textContent = 'Média de share: ' + formatShare(summary.averageShare || 0);
        infoWrap.appendChild(average);
        var active = document.createElement('span');
        var activeCount = summary.activeCount || 0;
        var totalCount = summary.totalCount || entries.length;
        if (summary.limitApplied && summary.targetRecipients) {
          active.textContent = 'URLs com tráfego: ' + activeCount + ' / ' + summary.targetRecipients;
        } else if (totalCount) {
          active.textContent = 'URLs com tráfego: ' + activeCount + ' de ' + totalCount;
        } else {
          active.textContent = 'URLs com tráfego: ' + activeCount;
        }
        infoWrap.appendChild(active);
        if (summary.priorityCount) {
          var priorityInfo = document.createElement('span');
          var priorityTargetShare = summary.priorityShareTarget != null ? summary.priorityShareTarget : 0;
          var priorityActive = summary.priorityActive != null ? summary.priorityActive : 0;
          priorityInfo.textContent = 'Prioritárias: ' + priorityActive + ' de ' + summary.priorityCount + ' • alvo ' + formatShare(priorityTargetShare || 0);
          infoWrap.appendChild(priorityInfo);
        }
        if (summary.priorityShareActual != null) {
          var priorityShare = document.createElement('span');
          priorityShare.textContent = 'Tráfego prioritário: ' + formatShare(summary.priorityShareActual || 0);
          infoWrap.appendChild(priorityShare);
        }
        if (summary.betMode) {
          var betInfo = document.createElement('span');
          var betShare = formatShare(summary.betShareActual || 0);
          betInfo.textContent = 'Modo apostas ativo • tráfego: ' + betShare + ' (' + (summary.betRecipients || 0) + ' URLs)';
          infoWrap.appendChild(betInfo);
        }
        if (summary.missingShare != null && summary.missingShare > 0) {
          var reserved = document.createElement('span');
          reserved.textContent = 'Reservado sem dados: ' + formatShare(summary.missingShare || 0);
          infoWrap.appendChild(reserved);
          var availableShare = summary.availableShare != null ? summary.availableShare : (1 - (summary.missingShare || 0));
          var available = document.createElement('span');
          available.textContent = 'Plano distribui: ' + formatShare(availableShare);
          infoWrap.appendChild(available);
        }
        if (!summary.limitApplied && summary.targetRecipients) {
          var targetInfo = document.createElement('span');
          targetInfo.textContent = 'Meta de URLs: ' + summary.targetRecipients;
          infoWrap.appendChild(targetInfo);
        }
        if (summary.limitApplied) {
          var limitBadge = document.createElement('span');
          limitBadge.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-500/10 text-amber-200 border border-amber-400/40 text-xs';
          limitBadge.innerHTML = '<svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/></svg>Limite ativo';
          infoWrap.appendChild(limitBadge);
        }
        header.appendChild(infoWrap);
        card.appendChild(header);

        var list = document.createElement('div');
        list.className = 'space-y-2 max-h-96 overflow-auto scroll-list-15';
        entries.forEach(function (row, index) {
          var share = row.suggestedGlobalShare || 0;
          var item = document.createElement('div');
          item.className = 'p-3 rounded-xl bg-slate-900/40 border border-slate-800/70 space-y-2';
          if (share <= 0) {
            item.classList.add('opacity-70');
          }
          var topRow = document.createElement('div');
          topRow.className = 'flex items-start justify-between gap-3';

          var titleWrap = document.createElement('div');
          titleWrap.className = 'flex flex-col gap-1';
          var urlEl = document.createElement('div');
          urlEl.className = 'text-sm font-semibold text-sky-300 break-all';
          urlEl.textContent = row.url || '-';
          titleWrap.appendChild(urlEl);
          var siteEl = document.createElement('div');
          siteEl.className = 'text-xs text-slate-400';
          siteEl.textContent = 'Site: ' + (row.site || '-');
          titleWrap.appendChild(siteEl);
          topRow.appendChild(titleWrap);

          var shareWrap = document.createElement('div');
          shareWrap.className = 'flex flex-col items-end gap-1';
          var rank = document.createElement('span');
          rank.className = 'inline-flex items-center justify-center px-2 py-0.5 rounded-full bg-slate-800/70 text-xs text-slate-300 border border-slate-700/60';
          rank.textContent = '#' + (index + 1);
          shareWrap.appendChild(rank);
          var shareEl = document.createElement('div');
          shareEl.className = 'text-sm font-semibold text-slate-100';
          shareEl.textContent = formatShare(share);
          shareWrap.appendChild(shareEl);
          topRow.appendChild(shareWrap);
          item.appendChild(topRow);

          var meta = document.createElement('div');
          meta.className = 'flex flex-wrap items-center gap-2 text-xs text-slate-300';
          meta.innerHTML = '' +
            '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">' +
            '<svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4l3 8 4-16 3 8h4"/></svg>' + formatCurrency(computeEffectiveEcpm(row) || 0) + ' eCPM ef.</span>' +
            '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">' +
            '<svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4l3 8 4-16 3 8h4"/></svg>' + formatCurrency(row.rps || 0) + ' RPS</span>' +
            '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">' +
            '<svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h4a1 1 0 011 1v8a1 1 0 01-1 1H3m0-10V5a2 2 0 012-2h2a2 2 0 012 2v2m-6 0h6"/></svg>' + formatNumber(row.suggestedSessions || 0) + '</span>' +
            '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">Site ' + formatShare(row.suggestedShare || 0) + '</span>' +
            '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">Δ ' + formatDeltaShare(row.deltaGlobalShare || 0) + '</span>' +
            '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">Cov ' + formatPercent(row.coverage || 0) + '</span>';
          if (row.performanceScore != null) {
            meta.innerHTML += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-200 border border-emerald-400/40">Desempenho ' + formatShare(row.performanceScore || 0) + '</span>';
          }
          if (row.priority) {
            meta.innerHTML += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-purple-500/15 text-purple-200 border border-purple-400/40">Prioritária</span>';
          }
          if (row.bet) {
            meta.innerHTML += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-500/15 text-amber-200 border border-amber-400/40">Aposta</span>';
          }
          if (row.guaranteed) {
            meta.innerHTML += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-indigo-500/15 text-indigo-200 border border-indigo-400/40">Garantido</span>';
          }
          if (share <= 0 || row.limited) {
            meta.innerHTML += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-500/10 text-slate-200 border border-slate-500/30">Sem tráfego</span>';
          }
          if (row.status) {
            meta.innerHTML += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">' + escapeHtml(row.status) + '</span>';
          }
          if (row.nextEval) {
            meta.innerHTML += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/70 border border-slate-700/60">Próx: ' + escapeHtml(row.nextEval) + '</span>';
          }
          item.appendChild(meta);
          if (row.performanceScore != null) {
            var perfBox = document.createElement('div');
            perfBox.className = 'w-full rounded-lg bg-slate-900/60 border border-slate-700/50 p-3 space-y-1 text-xs leading-snug text-slate-300';
            var perfTitle = document.createElement('div');
            perfTitle.className = 'text-slate-100 font-semibold';
            perfTitle.textContent = 'Desempenho composto ' + formatShare(row.performanceScore || 0);
            perfBox.appendChild(perfTitle);
            var perfBreakdown = document.createElement('div');
            perfBreakdown.textContent = 'Score ' + formatShare(row.performanceNormalizedScore || 0) + ' • eCPM ' + formatShare(row.performanceNormalizedEcpm || 0) + ' • RPS ' + formatShare(row.performanceNormalizedRps || 0);
            perfBox.appendChild(perfBreakdown);
            item.appendChild(perfBox);
          }
          if (row.reason) {
            var reason = document.createElement('div');
            reason.className = 'text-xs text-slate-400 leading-snug';
            reason.textContent = row.reason;
            item.appendChild(reason);
          }
          list.appendChild(item);
        });
        card.appendChild(list);
        return card;
      }

      function renderDistributionUrlsCard(distribution) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between gap-3 flex-wrap';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Sugestão por URL';
        header.appendChild(title);
        card.appendChild(header);
        var selectedSite = state.distribution.selectedSite;
        if (!selectedSite) {
          var emptySelection = document.createElement('div');
          emptySelection.className = 'text-sm text-slate-400';
          emptySelection.textContent = 'Selecione um site para visualizar a distribuição entre URLs.';
          card.appendChild(emptySelection);
          return card;
        }
        var siteRows = distribution && distribution.urlsBySite ? distribution.urlsBySite[selectedSite] || [] : [];
        if (!siteRows.length) {
          var emptyRows = document.createElement('div');
          emptyRows.className = 'text-sm text-slate-400';
          emptyRows.textContent = 'Sem URLs suficientes para o site selecionado.';
          card.appendChild(emptyRows);
          return card;
        }
        var searchWrapper = document.createElement('div');
        searchWrapper.className = 'flex items-center justify-between gap-3 flex-wrap';
        var searchLabel = document.createElement('label');
        searchLabel.className = 'text-xs uppercase tracking-wide text-slate-400';
        searchLabel.setAttribute('for', 'distribution-url-busca');
        searchLabel.textContent = 'Filtrar';
        var searchInput = document.createElement('input');
        searchInput.id = 'distribution-url-busca';
        searchInput.type = 'search';
        searchInput.className = 'pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100 w-full md:w-80';
        searchInput.placeholder = 'Buscar por URL';
        searchInput.value = state.distribution.urlSearch || '';
        searchInput.addEventListener('input', function (ev) {
          state.distribution.urlSearch = ev.target.value;
          renderAnalysis();
        });
        searchWrapper.appendChild(searchLabel);
        searchWrapper.appendChild(searchInput);
        card.appendChild(searchWrapper);

        var filteredRows = siteRows;
        var filterValue = (state.distribution.urlSearch || '').trim().toLowerCase();
        if (filterValue) {
          filteredRows = siteRows.filter(function (row) {
            return String(row.url || '').toLowerCase().indexOf(filterValue) !== -1;
          });
        }
        if (!filteredRows.length) {
          var emptyFilter = document.createElement('div');
          emptyFilter.className = 'text-sm text-slate-400';
          emptyFilter.textContent = 'Nenhuma URL encontrada para o filtro informado.';
          card.appendChild(emptyFilter);
          return card;
        }
        var sortedUrls = sortDistributionUrlRows(filteredRows);
        var tableWrap = document.createElement('div');
        tableWrap.className = 'overflow-auto scroll-list-15';
        var html = '';
        html += '<table class="w-full text-sm min-w-max">';
        html += '<thead class="text-slate-300 table-head-sticky">';
        html += '<tr>' +
          '<th class="px-3 py-2 text-left font-semibold">' + buildSortHeader('distributionUrls', 'url', 'URL', 'left') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'sessions', 'Sessões (3h)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'rps', 'RPS ($)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'coverage', 'Cobertura (%)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'ecpmEff', 'eCPM Efetivo ($)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'momentum', 'Momentum', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'score', 'Score', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'performanceScore', 'Desempenho (%)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'currentShare', '% Atual', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'suggestedShare', '% Sugerida', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'suggestedGlobalShare', '% Global', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('distributionUrls', 'deltaShare', 'Δ%', 'right') + '</th>' +
          '<th class="px-3 py-2 text-center font-semibold">' + buildSortHeader('distributionUrls', 'status', 'Status', 'center') + '</th>' +
          '<th class="px-3 py-2 text-left font-semibold">' + buildSortHeader('distributionUrls', 'nextEval', 'Próx. avaliação', 'left') + '</th>' +
          '</tr>';
        html += '</thead><tbody class="divide-y divide-slate-800/60">';
        sortedUrls.forEach(function (row) {
          var statusLower = String(row.status || '').toLowerCase();
          var statusClass = statusLower === 'alerta' ? 'bg-rose-500/10 text-rose-200 border border-rose-400/40' : statusLower === 'seed' ? 'bg-sky-500/10 text-sky-200 border border-sky-400/30' : 'bg-emerald-500/10 text-emerald-200 border border-emerald-400/30';
          var effectiveEcpm = computeEffectiveEcpm(row);
          html += '<tr>' +
            '<td class="px-3 py-2 text-sky-300 break-all">' + escapeHtml(row.url || '') + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatNumber(row.sessions) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(row.rps) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatPercent(row.coverage) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatCurrency(effectiveEcpm) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatTrend(row.momentum) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(row.score) + '</td>' +
          '<td class="px-3 py-2 text-right">' + formatShare(row.performanceScore) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatShare(row.currentShare) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatShare(row.suggestedShare) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatShare(row.suggestedGlobalShare) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatDeltaShare(row.deltaShare) + '</td>' +
            '<td class="px-3 py-2 text-center"><div class="flex items-center justify-center gap-2 flex-wrap">' +
            '<span class="px-2 py-1 rounded-full text-xs ' + statusClass + '">' + escapeHtml(row.status || 'ok') + '</span>' +
            (row.guaranteed ? '<span class="px-2 py-1 rounded-full text-xs bg-indigo-500/15 text-indigo-200 border border-indigo-400/40">Garantido</span>' : '') +
            (row.limited ? '<span class="px-2 py-1 rounded-full text-xs bg-slate-500/10 text-slate-200 border border-slate-500/30">Sem tráfego</span>' : '') +
            '</div></td>' +
            '<td class="px-3 py-2 text-left text-slate-300">' + escapeHtml(row.nextEval || '-') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
        tableWrap.innerHTML = html;
        card.appendChild(tableWrap);
        attachSortHandlers(card);
        return card;
      }

      function resolveDistributionSelection(distribution) {
        if (!state.distribution) return;
        var sites = distribution && distribution.sites ? distribution.sites : [];
        if (!sites.length) {
          state.distribution.selectedSite = '';
          return;
        }
        var selected = state.distribution.selectedSite;
        var exists = selected && sites.some(function (row) { return row.site === selected; });
        if (!exists) {
          state.distribution.selectedSite = distribution.selectedSite || sites[0].site;
        }
      }

      function sortDistributionSiteRows(rows) {
        var sortState = getSortState('distributionSites');
        if (!sortState) return rows.slice();
        var multiplier = sortState.direction === 'asc' ? 1 : -1;
        var key = sortState.key;
        return rows.slice().sort(function (a, b) {
          var av = getDistributionSiteSortValue(a, key);
          var bv = getDistributionSiteSortValue(b, key);
          if (typeof av === 'string' || typeof bv === 'string') {
            return String(av).localeCompare(String(bv)) * multiplier;
          }
          return (av - bv) * multiplier;
        });
      }

      function getDistributionSiteSortValue(row, key) {
        if (key === 'site') return (row.site || '').toLowerCase();
        if (key === 'rps') return Number(row.rps || 0);
        if (key === 'coverage') return Number(row.coverage || 0);
        if (key === 'ecpmEff') return computeEffectiveEcpm(row);
        if (key === 'momentum') return Number(row.momentum || 0);
        if (key === 'confidence') return Number(row.confidence || 0);
        if (key === 'currentShare') return Number(row.currentShare || 0);
        if (key === 'suggestedShare') return Number(row.suggestedShare || 0);
        if (key === 'deltaShare') return Number(row.deltaShare || 0);
        if (key === 'mode') return (row.mode || '').toLowerCase();
        if (key === 'nextEvaluation') return (row.nextEvaluation || '').toLowerCase();
        return 0;
      }

      function sortDistributionUrlRows(rows) {
        var sortState = getSortState('distributionUrls');
        if (!sortState) return rows.slice();
        var multiplier = sortState.direction === 'asc' ? 1 : -1;
        var key = sortState.key;
        return rows.slice().sort(function (a, b) {
          var av = getDistributionUrlSortValue(a, key);
          var bv = getDistributionUrlSortValue(b, key);
          if (typeof av === 'string' || typeof bv === 'string') {
            return String(av).localeCompare(String(bv)) * multiplier;
          }
          return (av - bv) * multiplier;
        });
      }

      function getDistributionUrlSortValue(row, key) {
        if (key === 'url') return (row.url || '').toLowerCase();
        if (key === 'sessions') return Number(row.sessions || 0);
        if (key === 'rps') return Number(row.rps || 0);
        if (key === 'coverage') return Number(row.coverage || 0);
        if (key === 'ecpmEff') return computeEffectiveEcpm(row);
        if (key === 'momentum') return Number(row.momentum || 0);
        if (key === 'score') return Number(row.score || 0);
        if (key === 'performanceScore') return Number(row.performanceScore || 0);
        if (key === 'currentShare') return Number(row.currentShare || 0);
        if (key === 'suggestedShare') return Number(row.suggestedShare || 0);
        if (key === 'suggestedGlobalShare') return Number(row.suggestedGlobalShare || 0);
        if (key === 'deltaShare') return Number(row.deltaShare || 0);
        if (key === 'status') return (row.status || '').toLowerCase();
        if (key === 'nextEval') return (row.nextEval || '').toLowerCase();
        return 0;
      }

      function ensureDistributionState() {
        if (!state.distribution) {
          state.distribution = { params: null, selectedSite: '', urlSearch: '', dirty: false, contextKey: '', minimums: [] };
          return;
        }
        if (!('params' in state.distribution)) {
          state.distribution.params = null;
        }
        if (!('selectedSite' in state.distribution)) {
          state.distribution.selectedSite = '';
        }
        if (!('urlSearch' in state.distribution)) {
          state.distribution.urlSearch = '';
        }
        if (!('dirty' in state.distribution)) {
          state.distribution.dirty = false;
        }
        if (!('contextKey' in state.distribution)) {
          state.distribution.contextKey = '';
        }
        if (!Array.isArray(state.distribution.minimums)) {
          state.distribution.minimums = [];
        }
      }

      function normalizeDistributionMinimum(entry) {
        var normalized = { url: '', share: 0, site: '' };
        if (!entry) {
          return normalized;
        }
        if (typeof entry.url === 'string') {
          normalized.url = entry.url.trim();
        } else if (typeof entry.link === 'string') {
          normalized.url = entry.link.trim();
        }
        var shareValue = entry.share;
        if (shareValue == null && entry.minShare != null) shareValue = entry.minShare;
        if (shareValue == null && entry.minimumShare != null) shareValue = entry.minimumShare;
        if (shareValue == null && entry.percent != null) shareValue = entry.percent;
        if (shareValue == null && entry.percentage != null) shareValue = entry.percentage;
        if (shareValue == null && entry.sharePercent != null) {
          var percentCandidate = Number(entry.sharePercent);
          if (!isNaN(percentCandidate)) {
            shareValue = percentCandidate > 1 ? percentCandidate / 100 : percentCandidate;
          }
        }
        var parsedShare = Number(shareValue);
        if (!isNaN(parsedShare) && isFinite(parsedShare)) {
          if (parsedShare > 1 && parsedShare <= 100) {
            normalized.share = parsedShare / 100;
          } else {
            normalized.share = parsedShare;
          }
          if (normalized.share < 0) {
            normalized.share = 0;
          }
        }
        if (typeof entry.site === 'string') {
          normalized.site = entry.site;
        } else if (typeof entry.domain === 'string') {
          normalized.site = entry.domain;
        }
        return normalized;
      }

      function distributionMinimumsEqual(a, b) {
        if (!Array.isArray(a) || !Array.isArray(b)) {
          return Array.isArray(a) === Array.isArray(b);
        }
        if (a.length !== b.length) {
          return false;
        }
        for (var i = 0; i < a.length; i++) {
          var left = a[i] || {};
          var right = b[i] || {};
          var leftUrl = (left.url || '').trim();
          var rightUrl = (right.url || '').trim();
          if (leftUrl !== rightUrl) {
            return false;
          }
          var leftShare = Number(left.share || 0);
          var rightShare = Number(right.share || 0);
          if (Math.abs(leftShare - rightShare) > 1e-6) {
            return false;
          }
          if ((left.site || '') !== (right.site || '')) {
            return false;
          }
        }
        return true;
      }

      function getDistributionMinimums() {
        ensureDistributionState();
        return state.distribution.minimums;
      }

      function setDistributionMinimums(minimums, options) {
        ensureDistributionState();
        var sanitized = Array.isArray(minimums)
          ? minimums.map(function (item) {
              return normalizeDistributionMinimum(item);
            })
          : [];
        var current = state.distribution.minimums || [];
        var changed = !distributionMinimumsEqual(current, sanitized);
        if (changed || !Array.isArray(current)) {
          state.distribution.minimums = sanitized;
        }
        if (changed && (!options || options.markDirty !== false)) {
          state.distribution.dirty = true;
        }
        return changed;
      }

      function addDistributionMinimum(options) {
        var current = getDistributionMinimums().slice();
        var defaultUrl = '';
        var defaultSite = '';
        if (Array.isArray(options) && options.length) {
          var used = {};
          current.forEach(function (entry) {
            var existingUrl = (entry && entry.url ? entry.url : '').trim().toLowerCase();
            if (existingUrl) {
              used[existingUrl] = true;
            }
          });
          for (var i = 0; i < options.length; i++) {
            var option = options[i];
            var optionUrl = (option && option.url ? option.url : '').trim();
            if (!optionUrl) continue;
            var normalized = optionUrl.toLowerCase();
            if (!used[normalized]) {
              defaultUrl = optionUrl;
              defaultSite = option && option.site ? option.site : '';
              break;
            }
          }
        }
        current.push(normalizeDistributionMinimum({ url: defaultUrl, share: 0.02, site: defaultSite }));
        return setDistributionMinimums(current);
      }

      function updateDistributionMinimum(index, changes) {
        var current = getDistributionMinimums();
        if (!current || index < 0 || index >= current.length) {
          return false;
        }
        var next = current.slice();
        next[index] = normalizeDistributionMinimum(Object.assign({}, next[index], changes || {}));
        return setDistributionMinimums(next);
      }

      function removeDistributionMinimum(index) {
        var current = getDistributionMinimums();
        if (!current || index < 0 || index >= current.length) {
          return false;
        }
        var next = current.slice();
        next.splice(index, 1);
        return setDistributionMinimums(next);
      }

      function hasDistributionMinimumUrl(url, ignoreIndex) {
        var normalized = String(url || '').trim().toLowerCase();
        if (!normalized) return false;
        var list = getDistributionMinimums();
        for (var i = 0; i < list.length; i++) {
          if (i === ignoreIndex) continue;
          var entry = list[i];
          if (!entry) continue;
          if (String(entry.url || '').trim().toLowerCase() === normalized) {
            return true;
          }
        }
        return false;
      }

      function collectDistributionUrlOptions(distribution) {
        var optionsMap = {};
        var addOption = function (url, site) {
          if (!url) return;
          var trimmed = String(url).trim();
          if (!trimmed) return;
          var key = trimmed.toLowerCase();
          if (!optionsMap[key]) {
            optionsMap[key] = { url: trimmed, site: site || '' };
          } else if (!optionsMap[key].site && site) {
            optionsMap[key].site = site;
          }
        };
        if (distribution) {
          if (distribution.urlsBySite) {
            Object.keys(distribution.urlsBySite).forEach(function (site) {
              var rows = distribution.urlsBySite[site] || [];
              rows.forEach(function (row) {
                addOption(row && row.url, row && (row.site || site));
              });
            });
          }
          if (distribution.globalUrls) {
            var summary = distribution.globalUrls;
            var pools = [];
            if (Array.isArray(summary.entries)) pools = pools.concat(summary.entries);
            if (Array.isArray(summary.all)) pools = pools.concat(summary.all);
            pools.forEach(function (row) {
              addOption(row && row.url, row && row.site);
            });
          }
          if (Array.isArray(distribution.missingRouteLinks)) {
            distribution.missingRouteLinks.forEach(function (item) {
              if (typeof item === 'string') {
                addOption(item, '');
              } else if (item && typeof item.url === 'string') {
                addOption(item.url, item.site || '');
              }
            });
          }
        }
        getDistributionMinimums().forEach(function (entry) {
          if (!entry) return;
          addOption(entry.url, entry.site);
        });
        return Object.keys(optionsMap)
          .map(function (key) {
            return optionsMap[key];
          })
          .sort(function (a, b) {
            return a.url.localeCompare(b.url);
          });
      }

      function extractDistributionMinimums(distribution) {
        if (!distribution) return [];
        var controls = distribution.controls || {};
        var candidate = null;
        var keys = ['urlFixedMinimums', 'urlGuaranteedMinimums', 'urlMinimums'];
        for (var i = 0; i < keys.length; i++) {
          var key = keys[i];
          if (controls && typeof controls[key] !== 'undefined') {
            candidate = controls[key];
            break;
          }
          if (typeof distribution[key] !== 'undefined') {
            candidate = distribution[key];
          }
        }
        if (candidate == null) {
          return [];
        }
        if (typeof candidate === 'string') {
          try {
            candidate = JSON.parse(candidate);
          } catch (error) {
            console.warn('Não foi possível interpretar os mínimos de URL retornados pela distribuição.', error);
            candidate = [];
          }
        }
        if (!Array.isArray(candidate)) {
          return [];
        }
        return candidate
          .map(function (item) {
            var url = item && typeof item.url === 'string' ? item.url : item && typeof item.link === 'string' ? item.link : '';
            var site = item && typeof item.site === 'string' ? item.site : item && typeof item.domain === 'string' ? item.domain : '';
            var shareValue = item
              ? item.share != null
                ? item.share
                : item.minShare != null
                ? item.minShare
                : item.minimumShare != null
                ? item.minimumShare
                : item.percent != null
                ? item.percent
                : item.percentage
              : 0;
            if (shareValue == null && item && item.sharePercent != null) {
              var percentCandidate = Number(item.sharePercent);
              if (!isNaN(percentCandidate)) {
                shareValue = percentCandidate > 1 ? percentCandidate / 100 : percentCandidate;
              }
            }
            return normalizeDistributionMinimum({ url: url, share: shareValue, site: site });
          })
          .filter(function (entry) {
            return entry.url;
          });
      }

      function updateDistributionParam(key, value) {
        ensureDistributionState();
        if (!state.distribution.params) {
          state.distribution.params = {};
        }
        var current = state.distribution.params[key];
        if (current === value) return;
        state.distribution.params[key] = value;
        state.distribution.dirty = true;
      }

      function getDistributionPayload() {
        ensureDistributionState();
        if (!state.distribution.params) return null;
        var currentKey = makeDistributionContextKey(state.filters.operation, state.filters.traffic, state.filters.route);
        if (!state.distribution.contextKey || state.distribution.contextKey !== currentKey) {
          return null;
        }
        var payload = {};
        Object.keys(state.distribution.params).forEach(function (key) {
          var value = state.distribution.params[key];
          if (value == null || value === '' || typeof value === 'object') {
            return;
          }
          var numeric = Number(value);
          if (!isNaN(numeric)) {
            payload[key] = numeric;
          }
        });
        var minimums = getDistributionMinimums()
          .filter(function (entry) {
            return entry && entry.url;
          })
          .map(function (entry) {
            var share = Number(entry.share || 0);
            if (share < 0) share = 0;
            var normalized = { url: entry.url, share: share };
            if (entry.site) {
              normalized.site = entry.site;
            }
            return normalized;
          })
          .filter(function (entry) {
            return entry.share > 0;
          });
        if (minimums.length) {
          payload.urlFixedMinimums = minimums;
        }
        return payload;
      }

      function syncDistributionState(distribution, force, contextKey) {
        ensureDistributionState();
        var shouldHydrate = force || !state.distribution.dirty;
        if (distribution && distribution.controls && shouldHydrate) {
          var controlsCopy = Object.assign({}, distribution.controls);
          delete controlsCopy.urlFixedMinimums;
          delete controlsCopy.urlGuaranteedMinimums;
          delete controlsCopy.urlMinimums;
          state.distribution.params = controlsCopy;
          state.distribution.dirty = false;
        } else if (!state.distribution.params) {
          state.distribution.params = {};
        }
        if (shouldHydrate) {
          setDistributionMinimums(extractDistributionMinimums(distribution), { markDirty: false });
        } else if (!Array.isArray(state.distribution.minimums)) {
          state.distribution.minimums = [];
        }
        if (typeof contextKey !== 'undefined') {
          state.distribution.contextKey = contextKey || '';
        }
        if (distribution && distribution.sites && distribution.sites.length) {
          var selected = state.distribution.selectedSite;
          var exists = selected && distribution.sites.some(function (row) { return row.site === selected; });
          if (!exists) {
            state.distribution.selectedSite = distribution.selectedSite || distribution.sites[0].site;
          }
        } else {
          state.distribution.selectedSite = '';
        }
      }

      function setAnalysisTab(tab) {
        if (state.analysisTab === tab) return;
        state.analysisTab = tab;
        renderAnalysis();
      }

      function recalcularDistribuicao() {
        if (!state.filters.operation || !state.filters.traffic) {
          showToast('Aplique os filtros principais antes de recalcular a distribuição.', 'error');
          return;
        }
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (data) {
            showLoading(false);
            normalizeDistributionEffectiveEcpm(data && data.distribution);
            state.analysis = data;
            var responseFilters = data && data.filters ? data.filters : {};
            state.filters.startDate = responseFilters.startDate || '';
            state.filters.endDate = responseFilters.endDate || '';
            var startInput = document.getElementById('filter-inicio');
            if (startInput) {
              startInput.value = responseFilters.startDate || '';
            }
            var endInput = document.getElementById('filter-fim');
            if (endInput) {
              endInput.value = responseFilters.endDate || '';
            }
            var contextKey = makeDistributionContextKey(
              responseFilters.operation || state.filters.operation,
              responseFilters.traffic || state.filters.traffic,
              state.filters.route
            );
            syncDistributionState(data && data.distribution, true, contextKey);
            renderAnalysis();
          })
          .withFailureHandler(handleError)
          .getDashboardData({
            operation: state.filters.operation,
            traffic: state.filters.traffic,
            routeSlug: getRouteSlugFromKey(state.filters.route),
            domainId: getRouteDomainIdFromKey(state.filters.route),
            startDate: state.filters.startDate,
            endDate: state.filters.endDate,
            urlWindow: state.filters.window,
            distribution: getDistributionPayload()
          });
      }

      function salvarDistribuicaoMinimos() {
        ensureDistributionState();
        if (!state.filters.operation || !state.filters.traffic) {
          showToast('Selecione operação e tráfego antes de salvar os percentuais mínimos.', 'error');
          return;
        }
        var routeKey = state.filters.route || '';
        var slug = getRouteSlugFromKey(routeKey);
        var domainId = getRouteDomainIdFromKey(routeKey);
        if (!slug) {
          showToast('Selecione o slug da rota para salvar os percentuais mínimos.', 'error');
          return;
        }
        var minimums = getDistributionMinimums()
          .filter(function (entry) {
            return entry && entry.url;
          })
          .map(function (entry) {
            var share = Number(entry.share || 0);
            if (share < 0) share = 0;
            if (share > 1) share = 1;
            return {
              url: (entry.url || '').trim(),
              site: entry.site || '',
              share: share
            };
          })
          .filter(function (entry) {
            return entry.url && entry.share > 0;
          });
        var totalShare = minimums.reduce(function (acc, item) {
          return acc + (item.share || 0);
        }, 0);
        if (totalShare > 1 + 1e-6) {
          showToast('A soma dos percentuais mínimos ultrapassa 100% do tráfego disponível. Ajuste antes de salvar.', 'error');
          return;
        }
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            showLoading(false);
            var stored = (result && result.minimums) || [];
            setDistributionMinimums(stored, { markDirty: false });
            showToast('Percentuais mínimos salvos.', 'success');
            recalcularDistribuicao();
          })
          .withFailureHandler(function (error) {
            showLoading(false);
            handleError(error);
          })
          .saveDistributionMinimumsConfig({
            operation: state.filters.operation,
            traffic: state.filters.traffic,
            routeSlug: slug,
            domainId: domainId,
            minimums: minimums
          });
      }

      function sincronizarDistribuicao() {
        if (state.syncingLinkRouter) {
          return;
        }
        if (!state.filters.operation || !state.filters.traffic) {
          showToast('Aplique os filtros principais antes de sincronizar com a API.', 'error');
          return;
        }
        var route = state.filters.route || '';
        var availableRoutes = getIntegrationRoutes(state.filters.operation, state.filters.traffic);
        if (!route && availableRoutes.length === 1) {
          route = makeRouteKeyFromItem(availableRoutes[0]);
          state.filters.route = route;
        }
        if (!route && availableRoutes.length > 1) {
          showToast('Selecione o slug da rota para sincronizar.', 'error');
          return;
        }
        var routeRecord = null;
        if (route) {
          var normalizedRoute = normalizeRouteKey(route);
          routeRecord = availableRoutes.find(function (item) {
            return normalizeRouteKey(makeRouteKeyFromItem(item)) === normalizedRoute;
          }) || null;
          if (!routeRecord) {
            showToast('Integração não encontrada para o slug selecionado.', 'error');
            return;
          }
        } else if (availableRoutes.length === 1) {
          routeRecord = availableRoutes[0];
        }
        if (routeRecord) {
          state.filters.route = makeRouteKeyFromItem(routeRecord);
        }
        var integration = routeRecord || (state.analysis && state.analysis.integration ? state.analysis.integration : null);
        if (integration) {
          var integrationKey = makeRouteKey(integration.routeSlug, integration.domainId);
          if (integrationKey) {
            state.filters.route = integrationKey;
          }
        }
        if (!integration || !integration.companyId || !integration.domainId || !integration.routeSlug) {
          showToast('Configure a integração do Link Router na aba Configuração antes de sincronizar.', 'error');
          return;
        }
        var distribution = state.analysis && state.analysis.distribution ? state.analysis.distribution : null;
        if (!distribution || !distribution.globalUrls || !distribution.globalUrls.all || !distribution.globalUrls.all.length) {
          showToast('Nenhum plano de distribuição disponível para sincronização.', 'error');
          return;
        }
        state.syncingLinkRouter = true;
        renderAnalysis();
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            state.syncingLinkRouter = false;
            showLoading(false);
            if (result && result.dashboard) {
              normalizeDistributionEffectiveEcpm(result.dashboard && result.dashboard.distribution);
              state.analysis = result.dashboard;
              var dashFilters = result.dashboard && result.dashboard.filters ? result.dashboard.filters : {};
              state.filters.startDate = dashFilters.startDate || '';
              state.filters.endDate = dashFilters.endDate || '';
              var startInput = document.getElementById('filter-inicio');
              if (startInput) {
                startInput.value = dashFilters.startDate || '';
              }
              var endInput = document.getElementById('filter-fim');
              if (endInput) {
                endInput.value = dashFilters.endDate || '';
              }
              var integrationResult = result.dashboard.integration;
              var responseRouteKey = makeRouteKey(dashFilters.route, dashFilters.domainId);
              if (!responseRouteKey && integrationResult) {
                responseRouteKey = makeRouteKey(integrationResult.routeSlug, integrationResult.domainId);
              }
              if (!responseRouteKey && integration) {
                responseRouteKey = makeRouteKey(integration.routeSlug, integration.domainId);
              }
              if (!responseRouteKey) {
                responseRouteKey = makeRouteKeyFromItem(routeRecord);
              }
              if (responseRouteKey) {
                state.filters.route = responseRouteKey;
              }
              var contextKey = makeDistributionContextKey(
                dashFilters.operation || state.filters.operation,
                dashFilters.traffic || state.filters.traffic,
                state.filters.route
              );
              syncDistributionState(result.dashboard.distribution, true, contextKey);
              updateRouteFilter();
            }
            renderAnalysis();
            var successMessage = result && result.message ? result.message : 'Percentuais sincronizados com sucesso.';
            showToast(successMessage, 'success');
            if (result) {
              var notices = [];
              if (result.leftoverShares && result.leftoverShares.length) {
                var leftoverPreview = result.leftoverShares.slice(0, 3).map(function (item) {
                  return (item.url || 'URL') + ' (' + formatShare(item.share || 0) + ')';
                });
                var leftoverExtra = result.leftoverShares.length > 3 ? ' +' + (result.leftoverShares.length - 3) + ' outras' : '';
                notices.push('URLs sugeridas não encontradas na API: ' + leftoverPreview.join(', ') + leftoverExtra);
              }
              if (result.unmatchedLinks && result.unmatchedLinks.length) {
                var unmatchedPreview = result.unmatchedLinks.slice(0, 3).map(function (url) { return url || 'URL'; });
                var unmatchedExtra = result.unmatchedLinks.length > 3 ? ' +' + (result.unmatchedLinks.length - 3) + ' outras' : '';
                notices.push('URLs da API sem correspondência no plano atual: ' + unmatchedPreview.join(', ') + unmatchedExtra);
              }
              notices.forEach(function (message) {
                showToast(message, 'info');
              });
            }
          })
          .withFailureHandler(function (err) {
            state.syncingLinkRouter = false;
            showLoading(false);
            renderAnalysis();
            handleError(err);
          })
          .syncLinkRouterDistribution({
            operation: state.filters.operation,
            traffic: state.filters.traffic,
            routeSlug: integration ? integration.routeSlug : getRouteSlugFromKey(state.filters.route),
            domainId: integration ? integration.domainId : getRouteDomainIdFromKey(state.filters.route),
            startDate: state.filters.startDate,
            endDate: state.filters.endDate,
            window: state.filters.window,
            distribution: getDistributionPayload()
          });
      }

      function getSortState(section) {
        return state.sort && state.sort[section] ? state.sort[section] : null;
      }

      function setSort(section, key) {
        if (!state.sort) state.sort = {};
        var current = state.sort[section];
        var direction = 'desc';
        if (current && current.key === key) {
          direction = current.direction === 'desc' ? 'asc' : 'desc';
        }
        state.sort[section] = { key: key, direction: direction };
        renderAnalysis();
      }

      function buildSortHeader(section, key, label, alignment) {
        var sortState = getSortState(section);
        var indicator = '\u2195';
        if (sortState && sortState.key === key) {
          indicator = sortState.direction === 'asc' ? '\u25B2' : '\u25BC';
        }
        var justify = 'justify-start';
        if (alignment === 'center') {
          justify = 'justify-center';
        } else if (alignment === 'right') {
          justify = 'justify-end';
        }
        return '<button type="button" class="sort-button ' + justify + '" data-sort-section="' + section + '" data-sort-key="' + key + '">' + escapeHtml(label) + '<span class="sort-indicator">' + indicator + '</span></button>';
      }

      function attachSortHandlers(container) {
        var buttons = container.querySelectorAll('[data-sort-section]');
        Array.prototype.forEach.call(buttons, function (button) {
          button.addEventListener('click', function (ev) {
            ev.preventDefault();
            var section = button.getAttribute('data-sort-section');
            var key = button.getAttribute('data-sort-key');
            setSort(section, key);
          });
        });
      }

      function sortSiteRows(rows) {
        var sortState = getSortState('site');
        if (!sortState) return rows.slice();
        var multiplier = sortState.direction === 'asc' ? 1 : -1;
        var key = sortState.key;
        return rows.slice().sort(function (a, b) {
          var av = getSiteSortValue(a, key);
          var bv = getSiteSortValue(b, key);
          if (typeof av === 'string' || typeof bv === 'string') {
            return av.localeCompare(bv) * multiplier;
          }
          return (av - bv) * multiplier;
        });
      }

      function getSiteSortValue(row, key) {
        if (key === 'site') return (row.site || '').toLowerCase();
        if (key === 'totalSessions') return Number(row.totalSessions || 0);
        if (key === 'totalRevenue') return Number(row.totalRevenue || 0);
        if (key === 'totalRps') return Number(row.totalRps || 0);
        return 0;
      }

      function sortUrlRows(rows) {
        var sortState = getSortState('url');
        if (!sortState) return rows.slice();
        var multiplier = sortState.direction === 'asc' ? 1 : -1;
        var key = sortState.key;
        return rows.slice().sort(function (a, b) {
          var av = getUrlSortValue(a, key);
          var bv = getUrlSortValue(b, key);
          if (typeof av === 'string' || typeof bv === 'string') {
            return av.localeCompare(bv) * multiplier;
          }
          return (av - bv) * multiplier;
        });
      }

      function getUrlSortValue(row, key) {
        if (key === 'url') return (row.url || '').toLowerCase();
        if (key === 'sessions') return Number(row.sessions || 0);
        if (key === 'revenue') return Number(row.revenue || 0);
        if (key === 'rps') return Number(row.rps || 0);
        if (key === 'coverage') return Number(row.coverage || 0);
        if (key === 'ecpm') return Number(row.ecpm || 0);
        if (key === 'effectiveEcpm') return Number(row.effectiveEcpm || 0);
        return 0;
      }

      function renderSiteCard(siteData) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Resumo por Site (últimas horas válidas)';
        card.appendChild(title);
        if (!siteData.rows || !siteData.rows.length) {
          var empty = document.createElement('div');
          empty.className = 'text-sm text-slate-400';
          empty.textContent = 'Sem dados de site para os filtros selecionados.';
          card.appendChild(empty);
          return card;
        }
        var hours = siteData.hours || [];
        var hoursHeaders = hours.map(function (h) { return h.label; });
        var rows = sortSiteRows(siteData.rows || []);
        var table = document.createElement('div');
        table.className = 'overflow-auto';
        var html = '';
        var sessionsSubHeaders = '';
        var revenueSubHeaders = '';
        var rpsSubHeaders = '';
        hoursHeaders.forEach(function (h, index) {
          var dividerClass = index === 0 ? ' metric-divider' : '';
          sessionsSubHeaders += '<th class="px-3 py-2 font-medium text-center metric-sub metric-sub-sessions' + dividerClass + '">' + h + '</th>';
          revenueSubHeaders += '<th class="px-3 py-2 font-medium text-center metric-sub metric-sub-revenue' + dividerClass + '">' + h + '</th>';
          rpsSubHeaders += '<th class="px-3 py-2 font-medium text-center metric-sub metric-sub-rps' + dividerClass + '">' + h + '</th>';
        });
        sessionsSubHeaders += '<th class="px-3 py-2 font-semibold text-center metric-sub metric-sub-sessions metric-total metric-divider">Total</th>';
        revenueSubHeaders += '<th class="px-3 py-2 font-semibold text-center metric-sub metric-sub-revenue metric-total metric-divider">Total</th>';
        rpsSubHeaders += '<th class="px-3 py-2 font-semibold text-center metric-sub metric-sub-rps metric-total metric-divider">Total</th>';

        html += '<table class="w-full text-sm min-w-max">';
        html += '<thead class="text-slate-200">';
        html += '<tr>' +
          '<th rowspan="2" class="px-3 py-3 text-left font-semibold align-middle site-header">' + buildSortHeader('site', 'site', 'Site', 'left') + '</th>' +
          '<th colspan="' + (hoursHeaders.length + 1) + '" class="px-3 py-2 text-center font-semibold metric-group metric-group-sessions metric-divider">' + buildSortHeader('site', 'totalSessions', 'Sessões', 'center') + '</th>' +
          '<th colspan="' + (hoursHeaders.length + 1) + '" class="px-3 py-2 text-center font-semibold metric-group metric-group-revenue metric-divider">' + buildSortHeader('site', 'totalRevenue', 'Receita ($)', 'center') + '</th>' +
          '<th colspan="' + (hoursHeaders.length + 1) + '" class="px-3 py-2 text-center font-semibold metric-group metric-group-rps metric-divider">' + buildSortHeader('site', 'totalRps', 'RPS ($)', 'center') + '</th>' +
          '</tr>';
        html += '<tr>' + sessionsSubHeaders + revenueSubHeaders + rpsSubHeaders + '</tr>';
        html += '</thead>';
        html += '<tbody class="divide-y divide-slate-800/60">';
        rows.forEach(function (row) {
          html += '<tr>';
          html += '<td class="px-3 py-2 font-medium text-slate-100 site-cell">' + escapeHtml(row.site) + '</td>';
          hours.forEach(function (hour, index) {
            var classes = 'px-3 py-2 text-center metric-cell-sessions';
            if (index === 0) classes += ' metric-divider';
            html += '<td class="' + classes + '">' + formatNumber(row.sessions[hour.key]) + '</td>';
          });
          var sessionsTotalClass = 'px-3 py-2 text-center metric-cell-sessions metric-total metric-divider';
          html += '<td class="' + sessionsTotalClass + '">' + formatNumber(row.totalSessions) + '</td>';
          hours.forEach(function (hour, index) {
            var classes = 'px-3 py-2 text-center metric-cell-revenue';
            if (index === 0) classes += ' metric-divider';
            html += '<td class="' + classes + '">' + formatCurrency(row.revenue[hour.key]) + '</td>';
          });
          var revenueTotalClass = 'px-3 py-2 text-center metric-cell-revenue metric-total metric-divider';
          html += '<td class="' + revenueTotalClass + '">' + formatCurrency(row.totalRevenue) + '</td>';
          hours.forEach(function (hour, index) {
            var classes = 'px-3 py-2 text-center metric-cell-rps';
            if (index === 0) classes += ' metric-divider';
            html += '<td class="' + classes + '">' + formatCurrency(row.rps[hour.key]) + '</td>';
          });
          var rpsTotalClass = 'px-3 py-2 text-center metric-cell-rps metric-total metric-divider';
          html += '<td class="' + rpsTotalClass + '">' + formatCurrency(row.totalRps) + '</td>';
          html += '</tr>';
        });
        if (siteData.totals) {
          html += '<tr class="bg-slate-900/60 text-slate-100 font-semibold">';
          html += '<td class="px-3 py-2 site-cell metric-total">Total</td>';
          hours.forEach(function (hour, index) {
            var classes = 'px-3 py-2 text-center metric-cell-sessions';
            if (index === 0) classes += ' metric-divider';
            html += '<td class="' + classes + '">' + formatNumber(siteData.totals.sessions[hour.key]) + '</td>';
          });
          html += '<td class="px-3 py-2 text-center metric-cell-sessions metric-total metric-divider">' + formatNumber(siteData.totals.totalSessions) + '</td>';
          hours.forEach(function (hour, index) {
            var classes = 'px-3 py-2 text-center metric-cell-revenue';
            if (index === 0) classes += ' metric-divider';
            html += '<td class="' + classes + '">' + formatCurrency(siteData.totals.revenue[hour.key]) + '</td>';
          });
          html += '<td class="px-3 py-2 text-center metric-cell-revenue metric-total metric-divider">' + formatCurrency(siteData.totals.totalRevenue) + '</td>';
          hours.forEach(function (hour, index) {
            var classes = 'px-3 py-2 text-center metric-cell-rps';
            if (index === 0) classes += ' metric-divider';
            html += '<td class="' + classes + '">' + formatCurrency(siteData.totals.rps[hour.key]) + '</td>';
          });
          html += '<td class="px-3 py-2 text-center metric-cell-rps metric-total metric-divider">' + formatCurrency(siteData.totals.totalRps) + '</td>';
          html += '</tr>';
        }
        html += '</tbody></table>';
        table.innerHTML = html;
        card.appendChild(table);
        attachSortHandlers(card);
        return card;
      }

      function renderUrlCard(urlData, filters) {
        var card = document.createElement('div');
        card.className = 'card rounded-2xl p-6 space-y-4';
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between gap-3 flex-wrap';
        var title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-slate-100';
        title.textContent = 'Resumo por URL';
        var info = document.createElement('span');
        info.className = 'text-xs text-slate-400';
        var windowMap = {
          'day': 'Dia completo (exceto última hora)',
          'last6h': 'Últimas 6 horas válidas',
          'last3h': 'Últimas 3 horas válidas'
        };
        info.textContent = windowMap[filters && filters.window] || '';
        header.appendChild(title);
        header.appendChild(info);
        card.appendChild(header);
        var baseRows = urlData.rows || [];
        var searchWrapper = document.createElement('div');
        searchWrapper.className = 'flex items-center justify-between gap-3 flex-wrap';
        var searchLabel = document.createElement('label');
        searchLabel.setAttribute('for', 'url-busca');
        searchLabel.className = 'text-xs uppercase tracking-wide text-slate-400';
        searchLabel.textContent = 'Filtrar';
        var searchInput = document.createElement('input');
        searchInput.id = 'url-busca';
        searchInput.type = 'search';
        searchInput.className = 'pill px-3 py-2 rounded-lg bg-slate-900/40 text-sm text-slate-100 w-full md:w-80';
        searchInput.placeholder = 'Buscar por URL';
        searchInput.value = state.search.url || '';
        searchInput.addEventListener('input', function (ev) {
          var value = ev.target.value;
          var caret = ev.target.selectionStart || value.length;
          state.search.url = value;
          renderAnalysis();
          requestAnimationFrame(function () {
            var input = document.getElementById('url-busca');
            if (input) {
              input.focus();
              var next = Math.min(input.value.length, caret);
              try {
                input.setSelectionRange(next, next);
              } catch (e) {
                // ignore
              }
            }
          });
        });
        searchWrapper.appendChild(searchLabel);
        searchWrapper.appendChild(searchInput);
        card.appendChild(searchWrapper);
        if (!baseRows.length) {
          var emptyBase = document.createElement('div');
          emptyBase.className = 'text-sm text-slate-400';
          emptyBase.textContent = 'Sem dados suficientes para a janela selecionada.';
          card.appendChild(emptyBase);
          return card;
        }
        var searchValue = (state.search.url || '').trim().toLowerCase();
        var filteredRows = baseRows;
        if (searchValue) {
          filteredRows = baseRows.filter(function (row) {
            return String(row.url || '').toLowerCase().indexOf(searchValue) !== -1;
          });
        }
        if (!filteredRows.length) {
          var emptyFilter = document.createElement('div');
          emptyFilter.className = 'text-sm text-slate-400';
          emptyFilter.textContent = 'Nenhuma URL encontrada para o filtro informado.';
          card.appendChild(emptyFilter);
          return card;
        }
        var rows = sortUrlRows(filteredRows || []);
        var table = document.createElement('div');
        table.className = 'relative overflow-auto scroll-list-15';
        var html = '';
        html += '<table class="w-full text-sm min-w-max">';
        html += '<thead class="text-slate-300 table-head-sticky">';
        html += '<tr>' +
          '<th class="px-3 py-2 text-left font-semibold">' + buildSortHeader('url', 'url', 'URL', 'left') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('url', 'sessions', 'Sessões', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('url', 'revenue', 'Receita ($)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('url', 'rps', 'RPS ($)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('url', 'coverage', 'Cobertura (%)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('url', 'ecpm', 'eCPM ($)', 'right') + '</th>' +
          '<th class="px-3 py-2 text-right font-semibold">' + buildSortHeader('url', 'effectiveEcpm', 'eCPM Efetivo ($)', 'right') + '</th>' +
          '</tr>';
        html += '</thead><tbody class="divide-y divide-slate-800/60">';
        rows.forEach(function (row) {
          html += '<tr>' +
            '<td class="px-3 py-2 text-sky-300 break-all">' + escapeHtml(row.url || '') + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatNumber(row.sessions) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(row.revenue) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(row.rps) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatPercent(row.coverage) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(row.ecpm) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(row.effectiveEcpm) + '</td>' +
            '</tr>';
        });
        if (urlData.totals) {
          html += '<tr class="bg-slate-900/60 text-slate-100 font-semibold">' +
            '<td class="px-3 py-2">Total</td>' +
            '<td class="px-3 py-2 text-right">' + formatNumber(urlData.totals.sessions) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(urlData.totals.revenue) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(urlData.totals.rps) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatPercent(urlData.totals.coverage) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(urlData.totals.ecpm) + '</td>' +
            '<td class="px-3 py-2 text-right">' + formatCurrency(urlData.totals.effectiveEcpm) + '</td>' +
            '</tr>';
        }
        html += '</tbody></table>';
        table.innerHTML = html;
        card.appendChild(table);
        attachSortHandlers(card);
        return card;
      }

      function normalizeDistributionEffectiveEcpm(distribution) {
        if (!distribution) return;

        function normalizeRow(row) {
          if (!row) return;
          var effective = computeEffectiveEcpm(row);
          if (!isNaN(effective)) {
            row.ecpmEff = effective;
          }
          if (row.totals) {
            var totalsEffective = computeEffectiveEcpm(row.totals);
            if (!isNaN(totalsEffective)) {
              row.totals.effectiveEcpm = totalsEffective;
            }
          }
        }

        if (Array.isArray(distribution.sites)) {
          distribution.sites.forEach(function (siteRow) {
            normalizeRow(siteRow);
            if (siteRow && Array.isArray(siteRow.urls)) {
              siteRow.urls.forEach(normalizeRow);
            }
          });
        }

        var urlsBySite = distribution.urlsBySite || {};
        Object.keys(urlsBySite).forEach(function (key) {
          var list = urlsBySite[key];
          if (Array.isArray(list)) {
            list.forEach(normalizeRow);
          }
        });

        if (distribution.globalUrls) {
          var collections = [];
          if (Array.isArray(distribution.globalUrls.entries)) {
            collections.push(distribution.globalUrls.entries);
          }
          if (Array.isArray(distribution.globalUrls.all)) {
            collections.push(distribution.globalUrls.all);
          }
          collections.forEach(function (rows) {
            rows.forEach(normalizeRow);
          });
        }
      }

      function computeEffectiveEcpm(row) {
        if (!row) return 0;
        var ecpm = safeNumber(row.ecpm);
        var ratio = resolveCoverageRatio(row);
        if (!ratio && row.totals) {
          ratio = resolveCoverageRatio(row.totals);
        }
        return ecpm * ratio;
      }

      function resolveCoverageRatio(source) {
        if (!source) return 0;
        var ratioCandidate = 0;
        if (source.coverage != null && source.coverage !== '') {
          ratioCandidate = safeNumber(source.coverage);
          if (ratioCandidate > 1) {
            ratioCandidate = ratioCandidate / 100;
          }
        } else if (source.coverageRatio != null && source.coverageRatio !== '') {
          ratioCandidate = safeNumber(source.coverageRatio);
        }
        if (!isFinite(ratioCandidate)) {
          ratioCandidate = 0;
        }
        if (ratioCandidate < 0) {
          ratioCandidate = 0;
        }
        if (ratioCandidate > 1) {
          ratioCandidate = 1;
        }
        if (ratioCandidate === 0 && source.coverageRatio != null && source.coverageRatio !== '') {
          var fallback = safeNumber(source.coverageRatio);
          if (fallback > 1) {
            fallback = fallback / 100;
          }
          if (isFinite(fallback) && fallback > 0) {
            ratioCandidate = Math.min(Math.max(fallback, 0), 1);
          }
        }
        return ratioCandidate;
      }

      function safeNumber(value) {
        if (value === null || value === undefined || value === '') return 0;
        if (typeof value === 'number') {
          return isFinite(value) ? value : 0;
        }
        if (typeof value === 'string') {
          var trimmed = value.trim();
          if (!trimmed) return 0;
          var direct = Number(trimmed);
          if (!isNaN(direct)) {
            return direct;
          }
          var normalized = trimmed.replace(/\./g, '').replace(/,/g, '.');
          var parsed = Number(normalized);
          if (!isNaN(parsed)) {
            return parsed;
          }
          return 0;
        }
        var converted = Number(value);
        return isNaN(converted) ? 0 : converted;
      }

      function computeRpsValue(revenue, sessions) {
        var rev = Number(revenue || 0);
        var ses = Number(sessions || 0);
        if (!ses) return 0;
        return (rev / ses) * 1000;
      }

      function formatNumber(value) {
        var number = Number(value || 0);
        if (!number) return '0';
        return number.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
      }

      function formatCurrency(value) {
        var number = Number(value || 0);
        return '$ ' + number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatPercent(value) {
        var number = Number(value || 0);
        return number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' %';
      }

      function formatShare(value) {
        var number = Number(value || 0) * 100;
        return number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' %';
      }

      function formatDeltaShare(value) {
        var number = Number(value || 0) * 100;
        if (Math.abs(number) < 0.005) {
          return '0,00 %';
        }
        var sign = number > 0 ? '+' : '-';
        var formatted = Math.abs(number).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' %';
        return sign + formatted;
      }

      function formatScore(value) {
        var number = Number(value || 0);
        return number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatMultiplier(value) {
        var number = Number(value || 0);
        return number.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
      }

      function formatPercentFraction(value) {
        var number = Number(value || 0) * 100;
        return number.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + ' %';
      }

      function formatTrend(value) {
        var number = Number(value || 0) * 100;
        if (Math.abs(number) < 0.05) {
          return '0,0 %';
        }
        var sign = number > 0 ? '+' : '-';
        var formatted = Math.abs(number).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + ' %';
        return sign + formatted;
      }

      function formatInputNumber(value) {
        if (value === null || value === undefined || value === '') return '';
        var number = Number(value);
        if (isNaN(number)) return '';
        return number.toFixed(2);
      }

      function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function showLoading(show) {
        var overlay = document.getElementById('loading-overlay');
        var text = document.getElementById('loading-text');
        var hint = document.getElementById('loading-hint');
        if (!overlay) return;

        if (!show) {
          overlay.classList.add('hidden');
          if (text) {
            text.textContent = 'Carregando...';
          }
          if (hint) {
            hint.classList.add('hidden');
          }
          if (loadingTimeoutId) {
            clearTimeout(loadingTimeoutId);
            loadingTimeoutId = null;
          }
          loadingDelayedHintShown = false;
          return;
        }

        overlay.classList.remove('hidden');
        if (text) {
          text.textContent = 'Carregando...';
        }
        if (hint) {
          hint.classList.add('hidden');
        }
        if (loadingTimeoutId) {
          clearTimeout(loadingTimeoutId);
        }
        loadingDelayedHintShown = false;
        loadingTimeoutId = setTimeout(function () {
          var stillVisible = overlay && !overlay.classList.contains('hidden');
          if (!stillVisible) {
            return;
          }
          if (hint) {
            hint.classList.remove('hidden');
          }
          if (!loadingDelayedHintShown) {
            showToast('O carregamento está demorando. Verifique se a operação possui URLs ou rotas inconsistentes.', 'info');
            loadingDelayedHintShown = true;
          }
        }, 15000);
      }

      function showToast(message, type) {
        var container = document.getElementById('toast-container');
        var toast = document.createElement('div');
        toast.className = 'toast ' + (type === 'success' ? 'toast-success' : type === 'error' ? 'toast-error' : 'toast-info');
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(function () {
          toast.classList.add('hide');
          setTimeout(function () { toast.remove(); }, 400);
        }, 3000);
      }

      function handleError(error) {
        showLoading(false);
        showToast(error && error.message ? error.message : 'Erro ao executar ação.', 'error');
        console.error(error);
      }
    })();
  </script>
</body>
</html>